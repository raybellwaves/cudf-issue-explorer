{"assignees":[{"id":"MDQ6VXNlcjQ1Nzk1OTkx","login":"davidwendt","name":"David Wendt"}],"author":{"id":"MDQ6VXNlcjQ1Nzk1OTkx","is_bot":false,"login":"davidwendt","name":"David Wendt"},"body":"**Describe the issue**\r\nNightly builds are failing due to memcheck errors in specific gtests. The error appears to be `compute-sanitizer` tool issue which has been opened as nvbug 4553815.\r\nThis issue is to document the issue while working on possible workarounds until the bug is fixed.\r\n\r\nThe 2 errors appear as follows:\r\n```\r\n[ RUN      ] NumericValueIteratorTest/1.non_null_iterator\r\n========= Invalid __shared__ read of size 16 bytes\r\n=========     at 0x9670 in void cub::CUB_200200_700_750_800_860_900_NS::DeviceReduceSingleTileKernel<cub::CUB_200200_700_750_800_860_900_NS::DeviceReducePolicy<short, unsigned int, thrust::minimum<void>>::Policy600, short *, short *, unsigned int, thrust::minimum<void>, short, short>(T2, T3, T4, T5, T6)\r\n=========     by thread (0,0,0) in block (0,0,0)\r\n=========     Address 0x8 is misaligned\r\n=========     Saved host backtrace up to driver entry point at kernel launch time\r\n=========     Host Frame: [0x331d50]\r\n=========                in /usr/lib/x86_64-linux-gnu/libcuda.so.1\r\n=========     Host Frame: [0x14fb4]\r\n=========                in /usr/local/cuda/targets/x86_64-linux/lib/libcudart.so.12\r\n=========     Host Frame:cudaLaunchKernel [0x70aae]\r\n=========                in /usr/local/cuda/targets/x86_64-linux/lib/libcudart.so.12\r\n=========     Host Frame:cudaError cub::CUB_200200_700_750_800_860_900_NS::DeviceReduce::Reduce<short*, short*, thrust::minimum<void>, short, int>(void*, unsigned long&, short*, short*, int, thrust::minimum<void>, short, CUstream_st*) [clone .isra.0] [0x2fa199]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/ITERATOR_TEST\r\n```\r\n\r\n```\r\n[ RUN      ] MinMaxReductionTest/0.MinMaxTypes\r\n========= Invalid __shared__ read of size 16 bytes\r\n=========     at 0x4310 in void cub::CUB_200200_700_750_800_860_900_NS::DeviceReduceSingleTileKernel<cub::CUB_200200_700_750_800_860_900_NS::DeviceReducePolicy<short, unsigned int, cudf::detail::cast_functor_fn<short, cudf::DeviceMin>>::Policy600, thrust::transform_iterator<thrust::identity<short>, thrust::transform_iterator<cudf::detail::value_accessor<short>, thrust::counting_iterator<int, thrust::use_default, thrust::use_default, thrust::use_default>, thrust::use_default, thrust::use_default>, thrust::use_default, thrust::use_default>, short *, unsigned int, cudf::detail::cast_functor_fn<short, cudf::DeviceMin>, short, short>(T2, T3, T4, T5, T6)\r\n=========     by thread (0,0,0) in block (0,0,0)\r\n=========     Address 0x8 is misaligned\r\n=========     Saved host backtrace up to driver entry point at kernel launch time\r\n=========     Host Frame: [0x331d50]\r\n=========                in /usr/lib/x86_64-linux-gnu/libcuda.so.1\r\n=========     Host Frame: [0x14fb4]\r\n=========                in /usr/local/cuda/targets/x86_64-linux/lib/libcudart.so.12\r\n=========     Host Frame:cudaLaunchKernel [0x70aae]\r\n=========                in /usr/local/cuda/targets/x86_64-linux/lib/libcudart.so.12\r\n=========     Host Frame:cudaError cub::CUB_200200_700_750_800_860_900_NS::DeviceReduce::Reduce<thrust::transform_iterator<thrust::identity<short>, thrust::transform_iterator<cudf::detail::value_accessor<short>, thrust::counting_iterator<int, thrust::use_default, thrust::use_default, thrust::use_default>, thrust::use_default, thrust::use_default>, thrust::use_default, thrust::use_default>, short*, cudf::detail::cast_functor_fn<short, cudf::DeviceMin>, short, int>(void*, unsigned long&, thrust::transform_iterator<thrust::identity<short>, thrust::transform_iterator<cudf::detail::value_accessor<short>, thrust::counting_iterator<int, thrust::use_default, thrust::use_default, thrust::use_default>, thrust::use_default, thrust::use_default>, thrust::use_default, thrust::use_default>, short*, int, cudf::detail::cast_functor_fn<short, cudf::DeviceMin>, short, CUstream_st*) [clone .isra.0] [0x18950ae]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/../../../lib/libcudf.so\r\n=========     Host Frame:cudf::reduction::simple::detail::simple_reduction<short, short, cudf::reduction::detail::op::min>(cudf::column_view const&, std::optional<std::reference_wrapper<cudf::scalar const> >, rmm::cuda_stream_view, rmm::mr::device_memory_resource*)::{lambda()#2}::operator()() const [0x18984c3]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/../../../lib/libcudf.so\r\n=========     Host Frame:std::unique_ptr<cudf::scalar, std::default_delete<cudf::scalar> > cudf::reduction::simple::detail::simple_reduction<short, short, cudf::reduction::detail::op::min>(cudf::column_view const&, std::optional<std::reference_wrapper<cudf::scalar const> >, rmm::cuda_stream_view, rmm::mr::device_memory_resource*) [0x1898a70]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/../../../lib/libcudf.so\r\n=========     Host Frame:cudf::reduction::detail::min(cudf::column_view const&, cudf::data_type, std::optional<std::reference_wrapper<cudf::scalar const> >, rmm::cuda_stream_view, rmm::mr::device_memory_resource*) [0x187ea46]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/../../../lib/libcudf.so\r\n=========     Host Frame:decltype(auto) cudf::detail::aggregation_dispatcher<cudf::reduction::detail::reduce_dispatch_functor, cudf::reduce_aggregation const&>(cudf::aggregation::Kind, cudf::reduction::detail::reduce_dispatch_functor&&, cudf::reduce_aggregation const&) [0x193431e]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/../../../lib/libcudf.so\r\n=========     Host Frame:cudf::reduction::detail::reduce(cudf::column_view const&, cudf::reduce_aggregation const&, cudf::data_type, std::optional<std::reference_wrapper<cudf::scalar const> >, rmm::cuda_stream_view, rmm::mr::device_memory_resource*) [0x1934d71]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/../../../lib/libcudf.so\r\n=========     Host Frame:cudf::reduce(cudf::column_view const&, cudf::reduce_aggregation const&, cudf::data_type, rmm::mr::device_memory_resource*) [0x193583f]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/../../../lib/libcudf.so\r\n=========     Host Frame:std::pair<short, bool> ReductionTest<short>::reduction_test<short>(cudf::column_view const&, cudf::reduce_aggregation const&, std::optional<cudf::data_type>) [clone .constprop.0] [0x28ec47]\r\n=========                in /opt/conda/envs/test/bin/gtests/libcudf/./REDUCTIONS_TEST\r\n```\r\n\r\nIf these were real errors the should appear when running without `compute-sanitizer`.\r\nThe nvbug report includes a small reproducer that shows the error without any libcudf-specific code.\r\n\r\n**Steps/Code to reproduce**\r\n\r\n```\r\ncompute-sanitizer --tool memcheck gtests/ITERATOR_TEST --gtest_filter=NumericValueIteratorTest/1.non_null_iterator --rmm_mode=cuda\r\ncompute-sanitizer --tool memcheck gtests/REDUCTIONS_TEST--gtest_filter=MinMaxReductionTest/0.MinMaxTypes --rmm_mode=cuda\r\n\r\n```\r\nNote the failure only occurs on int16 (short) integer types when doing a min-reduction through CUB.\r\n\r\n**Additional context**\r\nThe error occurs as follows on various `compute-sanitizer` versions:\r\n```\r\n2022.3.0    ok\r\n2022.4.0    ok\r\n2022.4.1    fail\r\n2023.1.1    fail\r\n2023.2.2.0  fail\r\n2023.3.1    fail\r\n```\r\nIn general, it fails only with 12.0 and above.\r\n\r\n","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5-QyM9","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"We are skipping the problematic test to avoid CI failures as of #15259, but we don't have a fix for the underlying issue yet.","createdAt":"2024-05-17T20:22:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15258#issuecomment-2118329149","viewerDidAuthor":false}],"createdAt":"2024-03-08T19:52:34Z","id":"I_kwDOBWUGps6BvXtZ","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":15258,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"Nightly memcheck failure caused by compute-sanitizer bug","updatedAt":"2024-05-17T20:22:29Z","url":"https://github.com/rapidsai/cudf/issues/15258"}
