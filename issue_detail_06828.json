{"assignees":[],"author":{"id":"MDQ6VXNlcjM2MjczNzc=","is_bot":false,"login":"jangorecki","name":"Jan Gorecki"},"body":"**Describe the bug**\r\n\r\nI switched from using csv format to feather format and getting and error for the same dataset. Error is being raised during printing. Sorry for not having minimal example but python is not my native language.\r\n\r\n**Steps/Code to reproduce bug**\r\n\r\nGenerate data in csv and feather\r\n```sh\r\nRscript -e 'install.packages(c(\"data.table\",\"arrow\"))'\r\nwget https://raw.githubusercontent.com/h2oai/db-benchmark/629755352248c9538fbd924e56356e5592f268be/_data/groupby-datagen.R\r\nRscript groupby-datagen.R 1e7 1e2 0 0\r\nRscript -e 'arrow::write_feather(data.table::fread(\"G1_1e7_1e2_0_0.csv\", stringsAsFactors=TRUE, data.table=FALSE), \"G1_1e7_1e2_0_0.feather\")'\r\n```\r\n\r\ncudf using csv\r\n```py\r\nimport cudf as cu\r\nx = cu.read_csv(\"G1_1e7_1e2_0_0.csv\", header=0, dtype=['str','str','str','int32','int32','int32','int32','int32','float64'])\r\nx['id1'] = x['id1'].astype('category')\r\nx['id2'] = x['id2'].astype('category')\r\nx['id3'] = x['id3'].astype('category')\r\nans = x.groupby(['id1'],as_index=False).agg({'v1':'sum'})\r\nprint(ans.head(3), flush=True)\r\n```\r\n```\r\n     id1      v1\r\n0  id001  299542\r\n1  id002  300933\r\n2  id003  301968\r\n```\r\n\r\ncudf using feather\r\n```py\r\nimport cudf as cu\r\nx = cu.io.feather.read_feather(\"data/G1_1e7_1e2_0_0.feather\")\r\n#/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/cudf/io/feather.py:15: UserWarning: Using CPU via PyArrow to read #feather \r\n#dataset, this may be GPU accelerated in the future\r\n#  warnings.warn(\r\nans = x.groupby(['id1'],as_index=False).agg({'v1':'sum'})\r\nprint(ans.head(3), flush=True)\r\n```\r\n```\r\nTraceback (most recent call last):\r\n  File \"./cudf/groupby-cudf.py\", line 58, in <module>\r\n    print(ans.head(3), flush=True)\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/cudf/core/dataframe.py\", line 1025, in __str__\r\n    return self.to_string()\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/cudf/core/dataframe.py\", line 1022, in to_string\r\n    return self.__repr__()\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/cudf/core/dataframe.py\", line 1272, in __repr__\r\n    return self._clean_renderable_dataframe(output)\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/cudf/core/dataframe.py\", line 1151, in _clean_renderable_dataframe\r\n    output = output.to_pandas().to_string(\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/cudf/core/dataframe.py\", line 4861, in to_pandas\r\n    out_data[i] = self._data[col_key].to_pandas(index=out_index)\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/cudf/core/column/categorical.py\", line 935, in to_pandas\r\n    data = pd.Categorical.from_codes(\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/pandas/core/arrays/categorical.py\", line 606, in from_codes\r\n    dtype = CategoricalDtype._from_values_or_dtype(\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/pandas/core/dtypes/dtypes.py\", line 277, in _from_values_or_dtype\r\n    dtype = CategoricalDtype(categories, ordered)\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/pandas/core/dtypes/dtypes.py\", line 164, in __init__\r\n    self._finalize(categories, ordered, fastpath=False)\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/pandas/core/dtypes/dtypes.py\", line 318, in _finalize\r\n    categories = self.validate_categories(categories, fastpath=fastpath)\r\n  File \"/home/jan/anaconda3/envs/cudf/lib/python3.8/site-packages/pandas/core/dtypes/dtypes.py\", line 495, in validate_categories\r\n    raise ValueError(\"Categorical categories must be unique\")\r\nValueError: Categorical categories must be unique\r\n```\r\n\r\n**Expected behavior**\r\n\r\nPrinting `ans` should not raise error for feather source data, same as it doesn't for csv data.\r\n\r\n**Environment overview (please complete the following information)**\r\n\r\nbare-metal\r\ncudf installed from conda\r\n\r\n**Environment details**\r\n\r\n```\r\ncudf/print_env.sh\r\n#Traceback (most recent call last):\r\n#  File \"<stdin>\", line 1, in <module>\r\n#NameError: name 'cudf' is not defined\r\n```\r\n\r\ncudf 0.16\r\narrow 2.0.0\r\n","closed":false,"closedAt":null,"comments":[{"id":"MDEyOklzc3VlQ29tbWVudDczMjIzODE3NQ==","author":{"login":"kkraus14"},"authorAssociation":"COLLABORATOR","body":"`arrow 2.0.0`: We only currently support `arrow 1.0.1` currently. Any chance you could try with that version and let us know if the issue still persists?\r\n\r\nAlso, a reproducer that's standalone and doesn't require running an R script to generate the data would be greatly appreciated.","createdAt":"2020-11-23T15:37:14Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6828#issuecomment-732238175","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MDA5NDEwMA==","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been marked stale due to no recent activity in the past 30d. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed. This issue will be marked rotten if there is no activity in the next 60d.","createdAt":"2021-02-16T20:20:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6828#issuecomment-780094100","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MjYzODU5Nw==","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-90d` due to no recent activity in the past 90 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed.","createdAt":"2021-05-17T21:05:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6828#issuecomment-842638597","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0Mjk1ODA3MQ==","author":{"login":"jangorecki"},"authorAssociation":"NONE","body":"afaik issue still needs to be addressed.","createdAt":"2021-05-18T08:13:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6828#issuecomment-842958071","viewerDidAuthor":false}],"createdAt":"2020-11-21T09:00:14Z","id":"MDU6SXNzdWU3NDc5Nzk2ODg=","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"MDU6TGFiZWwxMTM5NzQxMjEz","name":"cuDF (Python)","description":"Affects Python cuDF API.","color":"1d76db"}],"milestone":null,"number":6828,"projectCards":[{"project":{"name":"Bug Squashing"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG] arrow data: Categorical categories must be unique","updatedAt":"2024-02-23T18:43:22Z","url":"https://github.com/rapidsai/cudf/issues/6828"}
