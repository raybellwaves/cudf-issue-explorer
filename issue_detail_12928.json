{"assignees":[],"author":{"id":"MDQ6VXNlcjg0NTczODg=","is_bot":false,"login":"beckernick","name":"Nick Becker"},"body":"When we convert a dataframe to a cupy array, we iterate over each column (as they’re independent allocations) and assign each one to a column in an empty matrix. This means it can be slow for thousands or millions of small columns.\r\n\r\nIn a select set of circumstances, all of the columns in a DataFrame may be part of a single, contiguous allocation of memory. One scenario in which this can occur is after a call to transpose. It would be nice if, in this scenario, we didn't need to iterate over every column when converting to a cupy array.\r\n\r\nA real-world example of when this can matter is if a user is trying to run a dot product after a calling transpose. Because of the bottleneck, we're slower than pandas by quite a bit.\r\n\r\n```python\r\nimport cudf\r\nimport cupy as cp\r\nimport pandas as pd\r\n\r\nnrows = 10000\r\nncols = 4\r\n\r\ngdf = cudf.DataFrame(cp.random.randint(0, 1000, size=(nrows, ncols)))\r\npdf = gdf.to_pandas()\r\n\r\n%time gdf.T.dot(gdf)\r\n%time pdf.T.dot(pdf)\r\nCPU times: user 1.52 s, sys: 3.96 ms, total: 1.53 s\r\nWall time: 1.53 s\r\nCPU times: user 912 µs, sys: 41 µs, total: 953 µs\r\nWall time: 855 µs\r\n```\r\n\r\nIf we were to do any special casing here, we'd want to closely evaluate any impact on performance for the more general case, as the dataframe to cupy codepath is used across the board.","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5XcDzE","author":{"login":"shwina"},"authorAssociation":"CONTRIBUTOR","body":"The resulting CuPy array would need to be F-contiguous, IIUC. Would that be alright?","createdAt":"2023-03-13T21:16:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/12928#issuecomment-1466973380","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5XpFIK","author":{"login":"wence-"},"authorAssociation":"CONTRIBUTOR","body":"> The resulting CuPy array would need to be F-contiguous, IIUC. Would that be alright?\r\n\r\nYes, since cupy dot handles that fine.\r\n\r\nThe right answer here (since the `.T` is already expensive) is to do:\r\n```\r\ntmp = gdf.values\r\nresult = cudf.DataFrame(tmp.T.dot(tmp))\r\n```\r\nBut that is certainly not as seamless","createdAt":"2023-03-15T16:46:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/12928#issuecomment-1470386698","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5Xp0_A","author":{"login":"beckernick"},"authorAssociation":"MEMBER","body":"Agreed, F contiguousness would be fine. With that said, if we decide that a fastpath for this sceniaro has a non-trivial cost (in performance or complexity) associated with it and isn't worth the cost, that's also reasonable.\r\n\r\nFor completeness, when the user hit this originally they switched to CuPy to do the operations (like Lawrence suggested).","createdAt":"2023-03-15T18:44:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/12928#issuecomment-1470582720","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5-QLaj","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"Related: #11648 ","createdAt":"2024-05-17T18:29:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/12928#issuecomment-2118170275","viewerDidAuthor":false}],"createdAt":"2023-03-13T14:59:58Z","id":"I_kwDOBWUGps5gqMUu","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMDEzOTg3MzUy","name":"0 - Backlog","description":"In queue waiting for assignment","color":"d4c5f9"},{"id":"MDU6TGFiZWwxMTM5NzQxMjEz","name":"cuDF (Python)","description":"Affects Python cuDF API.","color":"1d76db"}],"milestone":null,"number":12928,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Faster dataframe to cupy conversion when dataframe is a single allocation","updatedAt":"2024-05-17T18:29:20Z","url":"https://github.com/rapidsai/cudf/issues/12928"}
