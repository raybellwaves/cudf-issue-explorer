{"assignees":[{"id":"MDQ6VXNlcjIwNDYxMDEz","login":"rjzamora","name":"Richard (Rick) Zamora"}],"author":{"id":"MDQ6VXNlcjEzMTMxMDk4","is_bot":false,"login":"ChrisJar","name":""},"body":"**Describe the bug**\r\nThe dask_cudf merge functions returns too few rows when both the dtype of the column being merged on is mismatched (eg: `int64` on the left and `int32` on the right) _and_ when `npartitions>1`\r\n \r\n**Steps/Code to reproduce bug**\r\nHere's a reproducer showing that when the dtype is mismatched the number of rows returned is dependent on the number of partitions in the dataframes being merged:\r\n```python\r\nimport cupy as cp\r\nimport cudf\r\nimport dask_cudf\r\n\r\ndfa = cudf.DataFrame({\"a\":cp.random.randint(0,100,100000), \"b\":cp.random.normal(size=100000)})\r\ndfb = cudf.DataFrame({\"a\":cp.random.randint(0,100,100000), \"c\":cp.random.normal(size=100000)})\r\n\r\ndfa[\"a\"] = dfa[\"a\"].astype(\"int32\")\r\ndfb[\"a\"] = dfb[\"a\"].astype(\"int64\")\r\n\r\nddfa = dask_cudf.from_cudf(dfa, npartitions=4)\r\nddfb = dask_cudf.from_cudf(dfb, npartitions=4)\r\nprint(\"npartitions:\")\r\nprint(\"left: {}\".format(ddfa.npartitions))\r\nprint(\"right: {}\".format(ddfb.npartitions))\r\n\r\nprint(\"Number of rows in merge result:\")\r\nprint(len(ddfa.merge(ddfb, how=\"inner\", on=\"a\")))\r\nprint(\"*\"*30)\r\n\r\nddfa = ddfa.repartition(npartitions=3)\r\nddfb = ddfb.repartition(npartitions=3)\r\nprint(\"npartitions:\")\r\nprint(\"left: {}\".format(ddfa.npartitions))\r\nprint(\"right: {}\".format(ddfb.npartitions))\r\n\r\nprint(\"Number of rows in merge result:\")\r\nprint(len(ddfa.merge(ddfb, how=\"inner\", on=\"a\")))\r\nprint(\"*\"*30)\r\n\r\nddfa = ddfa.repartition(npartitions=2)\r\nddfb = ddfb.repartition(npartitions=2)\r\nprint(\"npartitions:\")\r\nprint(\"left: {}\".format(ddfa.npartitions))\r\nprint(\"right: {}\".format(ddfb.npartitions))\r\n\r\nprint(\"Number of rows in merge result:\")\r\nprint(len(ddfa.merge(ddfb, how=\"inner\", on=\"a\")))\r\nprint(\"*\"*30)\r\n\r\nddfa = ddfa.repartition(npartitions=1)\r\nddfb = ddfb.repartition(npartitions=1)\r\nprint(\"npartitions:\")\r\nprint(\"left: {}\".format(ddfa.npartitions))\r\nprint(\"right: {}\".format(ddfb.npartitions))\r\n\r\nprint(\"Number of rows in merge result:\")\r\nprint(len(ddfa.merge(ddfb, how=\"inner\", on=\"a\")))\r\nprint(\"*\"*30)\r\n```\r\nThis returns:\r\n```\r\nnpartitions:\r\nleft: 4\r\nright: 4\r\nNumber of rows in merge result:\r\n16083716\r\n******************************\r\nnpartitions:\r\nleft: 3\r\nright: 3\r\nNumber of rows in merge result:\r\n35342145\r\n******************************\r\nnpartitions:\r\nleft: 2\r\nright: 2\r\nNumber of rows in merge result:\r\n46959990\r\n******************************\r\nnpartitions:\r\nleft: 1\r\nright: 1\r\nNumber of rows in merge result:\r\n100006687\r\n******************************\r\n```\r\n\r\n**Expected behavior**\r\nIf we perform the same operation with just cudf we can see the expected result:\r\n```python\r\nimport cupy as cp\r\nimport cudf\r\n\r\ndfa = cudf.DataFrame({\"a\":cp.random.randint(0,100,100000), \"b\":cp.random.normal(size=100000)})\r\ndfb = cudf.DataFrame({\"a\":cp.random.randint(0,100,100000), \"c\":cp.random.normal(size=100000)})\r\n\r\ndfa[\"a\"] = dfa[\"a\"].astype(\"int32\")\r\ndfb[\"a\"] = dfb[\"a\"].astype(\"int64\")\r\n\r\nprint(len(ddfa.merge(ddfb, how=\"inner\", on=\"a\")))\r\n```\r\nwhich returns:\r\n```\r\n100006687\r\n```\r\nwhich is the same as the dask_cudf version when `npartitions=1`\r\n\r\n**Environment overview (please complete the following information)**\r\n - Environment location: Bare-metal\r\n - Method of cuDF install: conda\r\n\r\n\r\n**Environment details**\r\n```\r\ncudf                      22.08.00a220629 cuda_11_py38_gff63c0a745_173    rapidsai-nightly\r\ndask-cudf                 22.08.00a220629 cuda_11_py38_gff63c0a745_173    rapidsai-nightly\r\nlibcudf                   22.08.00a220629 cuda11_gff63c0a745_173    rapidsai-nightly\r\ndask                      2022.6.1           pyhd8ed1ab_0    conda-forge\r\ndask-core                 2022.6.1           pyhd8ed1ab_0    conda-forge\r\ndask-cuda                 22.08.00a220630         py38_21    rapidsai-nightly\r\ndistributed               2022.6.1           pyhd8ed1ab_0    conda-forge\r\n```\r\n\r\n**Note**\r\nThe same thing occurs when `how={\"left\", \"right\", \"outer\"}`","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5F5DAs","author":{"login":"VibhuJawa"},"authorAssociation":"MEMBER","body":"Thanks for triaging and raising this @ChrisJar .  I can confirm that i can reproduce this on my end too. \r\n\r\nSmaller minimal example for anyone interested. \r\n\r\n```python\r\nimport numpy as np\r\nimport cudf\r\nimport dask_cudf\r\n\r\ndf_a = cudf.DataFrame({'a':[1, 2, 3, 4, 5], 'b':[0]*5})\r\ndf_a['a']=df_a['a'].astype(np.int32)\r\n\r\ndf_b = cudf.DataFrame({'a':[5, 4, 3, 2, 1], 'c':[1]*5})\r\ndf_b['a']=df_b['a'].astype(np.int64)\r\nprint(\"cudf\\n\",df_a.merge(df_b))\r\nprint(\"--\"*10)\r\nddf_a = dask_cudf.from_cudf(df_a, npartitions=4)\r\nddf_b = dask_cudf.from_cudf(df_b, npartitions=4)\r\nprint(\"dask_cudf\\n\",ddf_a.merge(ddf_b).compute())\r\n```\r\n\r\n```\r\ncudf\r\n    a  b  c\r\n0  1  0  1\r\n1  2  0  1\r\n2  3  0  1\r\n3  4  0  1\r\n4  5  0  1\r\n--------------------\r\ndask_cudf\r\n    a  b  c\r\n0  3  0  1\r\n0  1  0  1\r\n```\r\n\r\n\r\nAlso note that this work with `dask_pandas` .\r\n```python\r\n\r\nimport numpy as np\r\nimport pandas as pd\r\nimport dask.dataframe\r\n\r\ndf_a = pd.DataFrame({'a':[1, 2, 3, 4, 5], 'b':[0]*5})\r\ndf_a['a']=df_a['a'].astype(np.int32)\r\n\r\ndf_b = pd.DataFrame({'a':[5, 4, 3, 2, 1], 'c':[1]*5})\r\ndf_b['a']=df_b['a'].astype(np.int64)\r\nprint(\"cudf\\n\",df_a.merge(df_b))\r\nprint(\"--\"*10)\r\nddf_a = dask.dataframe.from_pandas(df_a, npartitions=4)\r\nddf_b = dask.dataframe.from_pandas(df_b, npartitions=4)\r\nprint(\"dask_cudf\\n\",ddf_a.merge(ddf_b).compute())\r\n``` \r\n\r\n```\r\ncudf\r\n    a  b  c\r\n0  1  0  1\r\n1  2  0  1\r\n2  3  0  1\r\n3  4  0  1\r\n4  5  0  1\r\n--------------------\r\ndask_cudf\r\n    a  b  c\r\n0  1  0  1\r\n0  3  0  1\r\n1  4  0  1\r\n2  5  0  1\r\n3  2  0  1\r\n```\r\n","createdAt":"2022-07-01T17:53:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1172582444","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5F5Fq6","author":{"login":"VibhuJawa"},"authorAssociation":"MEMBER","body":"CC: @rjzamora , @galipremsagar ","createdAt":"2022-07-01T18:06:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1172593338","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5F5OS9","author":{"login":"rjzamora"},"authorAssociation":"MEMBER","body":"My immediate assumption is that \"int32\" and \"int64\" columns are hashing to different partitions, but I'll need to investigate a bit to say for sure.\r\n\r\n**EDIT**: I can confirm that `pd.util.hash_pandas_object` produces the same hash for \"int32\" and \"int64\" values, while `cudf.DataFrame.hash_values()` does not:\r\n\r\n```python\r\ncudf_a = cudf.DataFrame({\"a\": np.arange(10, dtype=\"int32\")}).hash_values()\r\ncudf_b = cudf.DataFrame({\"a\": np.arange(10, dtype=\"int64\")}).hash_values()\r\nassert all(cudf_a.values == cudf_b.values)  # FAILS\r\n\r\npd_a = pd.util.hash_pandas_object(pd.DataFrame({\"a\": np.arange(10, dtype=\"int32\")}))\r\npd_b = pd.util.hash_pandas_object(pd.DataFrame({\"a\": np.arange(10, dtype=\"int64\")}))\r\nassert all(pd_a.values == pd_b.values) # PASSES\r\n```","createdAt":"2022-07-01T18:55:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1172628669","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GDCe9","author":{"login":"rjzamora"},"authorAssociation":"MEMBER","body":"@ChrisJar @VibhuJawa - I just noticed that neither of you have mentioned the `UserWarning` you should get for the reproducers shared above. For example, I get the following message locally:\r\n\r\n```\r\n.../site-packages/dask/dataframe/multi.py:475: UserWarning: Merging dataframes with merge column data type mismatches: \r\n+---------------+------------+-------------+\r\n| Merge columns | left dtype | right dtype |\r\n+---------------+------------+-------------+\r\n| ('a', 'a')    | int32      | int64       |\r\n+---------------+------------+-------------+\r\nCast dtypes explicitly to avoid unexpected results.\r\n```\r\n\r\nI do think it makes sense to cast the columns automatically (when possible), but I just wanted to confirm that you are gettting this warning as well?","createdAt":"2022-07-05T15:35:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1175201725","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GDC3H","author":{"login":"galipremsagar"},"authorAssociation":"CONTRIBUTOR","body":"Yup, I did get that warning @rjzamora. ","createdAt":"2022-07-05T15:37:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1175203271","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GDEbx","author":{"login":"ChrisJar"},"authorAssociation":"CONTRIBUTOR","body":"Yup, so did I @rjzamora ","createdAt":"2022-07-05T15:43:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1175209713","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GHkde","author":{"login":"VibhuJawa"},"authorAssociation":"MEMBER","body":"@ChrisJar , Can you raise an issue on `dask-sql`  too just as it will be hard for users to work-around from that world as there the merge can be present deep inside a messy query.  ","createdAt":"2022-07-06T15:51:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1176389470","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GHw6p","author":{"login":"rjzamora"},"authorAssociation":"MEMBER","body":"@VibhuJawa - Do you have a sense for what kinds of dtype mismatch we should worry about from dask-sql.  It seems like we should be able to handle mismatched integer dtypes in Dask, but I wasn't planning on addressing anything else since the user should be getting a warning that their doing something dangerous/wrong (and \"general\" type-casting rules are pretty vague). However, you make a good point that the user may not have much control if they are working with the dask-sql API.","createdAt":"2022-07-06T16:39:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1176440489","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GH1aY","author":{"login":"VibhuJawa"},"authorAssociation":"MEMBER","body":"@rjzamora ,   I agree that  \"general\" type-casting rules are pretty vague so having a general agree-able behavior will be impossible. \r\n\r\n> What type of  dtype mismatch we should worry about from dask-sql.\r\n\r\nIn my opinion  we should handle merges b/w columns of similar dtype , say like `int32/int64` and `float32/float64` etc and FAIL loudly in other cases (like `int32`/`float32`,  `int32/uint32`  )  for `dask-sql`  .  \r\n\r\nI would love for @ayushdg  to weigh in on this as he is deep in the weeds for handling merging on the `dask-sql` side these days. \r\n\r\nJust for additional context, this issue was actually found when we were triaging incorrect results in a GPU-BDB dask-sql query   (See [issue](https://github.com/rapidsai/gpu-bdb/issues/262))\r\n","createdAt":"2022-07-06T16:59:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1176458904","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GH3bX","author":{"login":"rjzamora"},"authorAssociation":"MEMBER","body":">say like int32/int64 and float32/float64 etc\r\n\r\nIs it common to merge on floating-point columns? That sounds inherently dangerous to me, but I suppose it could be on an integer column that was accidentally or necessarily up-casted.","createdAt":"2022-07-06T17:04:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1176467159","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GH6BS","author":{"login":"VibhuJawa"},"authorAssociation":"MEMBER","body":"> Is it common to merge on floating-point columns? \r\n\r\nI dont this its common but as you say users can do that accidentally in workflows . A common example i have seen is when people read csvs  and it gets interpreted as different dtypes based on how the data is partitioned.   \r\n\r\nThat said we should have guard rails around it by failing specially in the dask-sql land  (will leave the dask-cudf  behavior to your judgment ) following spark behavior, Like In spark land this would raise something like below: \r\n\r\n```python\r\n Failed to merge incompatible data types IntegerType and DoubleType\r\n ```","createdAt":"2022-07-06T17:12:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1176477778","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5GH8AV","author":{"login":"ayushdg"},"authorAssociation":"MEMBER","body":"> In my opinion we should handle merges b/w columns of similar dtype , say like int32/int64 and float32/float64 etc and FAIL loudly in other cases (like int32/float32, int32/uint32 ) for dask-sql .\r\n\r\nAgreed, upcasting integer columns while joining on integer types should be handled by dask-cudf since it's something that works in cudf/pandas and in sql land integer based joins are common and the dtypes may vary. \r\n\r\nDask-sql will also show the same: `UserWarning` for dtypes but if it's a large query, it can be hard to diagnose which part of the query the warning is coming from. \r\n\r\n> Is it common to merge on floating-point columns? That sounds inherently dangerous to me, but I suppose it could be on an integer column that was accidentally or necessarily up-casted.\r\n\r\nEquality joins on float columns are very uncommon and most often happen accidentally. Happy to move that part of the discussion over to dask-sql to improve dtype checking during joins and raising more warnings. This issue can primarily focus on handling integer dtypes. ","createdAt":"2022-07-06T17:21:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1176485909","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5H7PYj","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-30d` due to no recent activity in the past 30 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed. This issue will be labeled `inactive-90d` if there is no activity in the next 60 days.","createdAt":"2022-08-05T18:03:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11189#issuecomment-1206711843","viewerDidAuthor":false}],"createdAt":"2022-07-01T17:22:10Z","id":"I_kwDOBWUGps5M_Q8P","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"MDU6TGFiZWwxMTg1MjQwODk4","name":"dask","description":"Dask issue","color":"fcc25d"}],"milestone":null,"number":11189,"projectCards":[{"project":{"name":"Bug Squashing"},"column":{"name":"Needs prioritizing"}},{"project":{"name":"v22.12 Release"},"column":{"name":"Issue-Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG] Dask_cudf merge function returns too few rows","updatedAt":"2024-02-23T18:42:25Z","url":"https://github.com/rapidsai/cudf/issues/11189"}
