{"assignees":[],"author":{"id":"MDQ6VXNlcjExMjY5ODE=","is_bot":false,"login":"wence-","name":"Lawrence Mitchell"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nThe libcudf detail API for `gather` allows one to separately specify how negative indices are handled (whether or not a negative index `i` should map to `i + length(column)`) and how out of bounds indices are handled (whether they should be nullified or not checked for).\r\n\r\nIn contrast, the public API only allows specifying the policy for out-of-bounds indices explicitly, whether or not negative indices are wrapped is a function of the signedness of the input map column: if the map is an unsigned type, then \"negative\" indices are not allowed, if the type is signed then wrapping occurs.\r\n\r\nIn cudf, there are cases where we ingest data where pandas specifies that the marker for \"missing\" data is `-1`. For example `MultiIndex` construction can take `levels` and `codes` where `codes` indexes levels and `-1` means \"produce a null\". Right now we use `cudf::gather` to produce the indexed levels, but must first pre-process the `codes` column to replace `-1` with an actually out of bounds size type. This requires an extra pass over the input (and copy to set values).\r\n\r\nWhenever we perform a join, we obtain gather maps from libcudf which store signed entries (`cudf::size_type`). The entries are guaranteed to either be positive and in-bounds or the sentinel value `std::numeric_limits<size_type>::min()` indicating that an output row should be nullified. Despite this knowledge, since the column we're using for the gather map is a signed type, we have no way of performing the gather without paying the cost of wrapping negative indices, which we _know_ will be a no-op.\r\n\r\n**Describe the solution you'd like**\r\nI'd like to be able to specify the treatment of negative indices independently of the signedness of the gather map when calling `cudf::gather`.\r\n\r\n**Describe alternatives you've considered**\r\n\r\nFor data ingest, we could just build the user input as an unsigned type. However, that has the disadvantage that they then don't see what they might \"expect\" if inspecting the result that cudf delivers.\r\n\r\nFor the join case, I don't think there is a way without copying the gather map (since it is UB to `reinterpret_cast` between pointers of different types).","closed":false,"closedAt":null,"comments":[],"createdAt":"2023-11-28T13:09:37Z","id":"I_kwDOBWUGps54EV4p","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMTM5NzQwNjY2","name":"libcudf","description":"Affects libcudf (C++/CUDA) code.","color":"c5def5"}],"milestone":null,"number":14511,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Expose `negative_index_policy` from `cudf::detail::gather` in public `cudf::gather` API","updatedAt":"2024-02-23T17:56:34Z","url":"https://github.com/rapidsai/cudf/issues/14511"}
