{"assignees":[{"id":"MDQ6VXNlcjE1MjIxMjg5","login":"jrhemstad","name":"Jake Hemstad"}],"author":{"id":"MDQ6VXNlcjE1MjIxMjg5","is_bot":false,"login":"jrhemstad","name":"Jake Hemstad"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\n`column_view` is so named because it is supposed to be a non-owning, \"view\" type. However, this is currently a half-truth because `column_view` _is_ an owning class! \r\n\r\n`column_view` stores a `vector<column_view>` internally for it's children. Since `vector` is an owning type, that makes `column_view` an owning type. \r\n\r\nThis has several ramifications. \r\n\r\nFirst of all `column_view` is not trivially copyable (which view types should be!).\r\n\r\nThe larger problem is more insidious. The fact that `column_view` contains a `vector` object is the ultimate cause of the many compiler errors that libcudf developers have seen about calling a `__host__` function from a `__host__ __device__` context. The full causal chain is complicated. \r\n\r\nAs @harrism described in https://github.com/rapidsai/rmm/pull/312:\r\n\r\n>Unfortunately, NVCC implicitly adds __host__ __device__ specifiers to explicitly defaulted functions that are called from both __host__ and __device__ (or __host__ __device__) functions. In libcudf, the type_dispatcher uses a __host__ __device__ function, so the above changed resulted in compiler errors since the default compiler-generated constructor necessarily invokes a host-only function. \r\n\r\nIn short, `column_view` has defaulted ctors. Since these ctors can be used within the context of the `type_dispatcher` (which is `__host__ __device__`), nvcc will implicitly add `__host__ __device__` to these ctors. These defaulted `column_view` ctors will invoke the member `vector` ctors (which are intrinsically `__host__` only). Thus, we end up with trying to call a `__host__` function (`vector` ctor/dtor) inside a `__host__ __device__` function (`column_view` ctor/dtor).\r\n\r\n**Describe the solution you'd like**\r\n\r\nRemove the `vector<column_view>` from `column_view` and instead replace it with `column_view* children` and `size_type num_children`:\r\n\r\n```c++\r\nclass column_view{\r\n\r\n   column_view(...., column_view * children, size_type num_children);\r\n\r\nprivate:\r\n   column_view * children; // pointer to array of child `column_view` objects\r\n   size_type num_children;\r\n};\r\n```\r\n\r\nThis will make `column_view` a true \"view\" type by being trivially copyable and eliminate any possibility for the host/device errors we've encountered numerous times in the past. \r\n\r\nBut what about the children!? \r\n\r\nThe catch is, someone has to own the children `column_view` objects, i.e., the `children` pointer in `column_view` has to point to `column_view` objects that are constructed/owned by someone else. There's two scenarios we have to consider:\r\n\r\n1. `column_view`s that view `cudf::column` objects\r\n2. `column_view`s that _do not_ view ` cudf::column` object (e.g., viewing a Python owned column)\r\n\r\nIn 1. the fix is pretty easy. We can just add a `vector<column_view>` to `cudf::column`:\r\n\r\n```c++\r\nclass column{\r\n\r\nprivate:\r\n   vector<unique_ptr<column>> children; // here's the owning child objects\r\n   vector<column_view> child_views; // non-owning views to the same children\r\n\r\npublic:\r\n   operator column_view(){\r\n       // pass pointer to the `child_view`s data when converting to a `column_view`\r\n       return column_view{..., child_views.data(), child_views.size()};\r\n   }\r\n};\r\n```\r\n\r\nSituation 2. shouldn't be too onerous either. The caller was already required to construct a `std::vector<column_view>` to pass the children to the `column_view` ctor. However, instead of copying that vector, we just take a pointer to it's contents. This does add the added responsibility of the user to ensure that the `column_view` does not outlive the `vector<column_view>` for the children. @shwina correct me if I'm wrong, but I don't anticipate this should be a problem from the Python/Cython side nor require significant changes? \r\n\r\n","closed":false,"closedAt":null,"comments":[{"id":"MDEyOklzc3VlQ29tbWVudDU5MjEwNjM3Mw==","author":{"login":"kkraus14"},"authorAssociation":"COLLABORATOR","body":"> @shwina correct me if I'm wrong, but I don't anticipate this should be a problem from the Python/Cython side nor require significant changes?\r\n\r\nWe currently release the buffers from a Column and those control the memory lifetime directly via smart pointers. For creating `column_view` instances, we currently have this function: https://github.com/rapidsai/cudf/blob/branch-0.13/python/cudf/cudf/_libxx/column.pyx#L335-L369\r\n\r\nIt sounds like we'll need to change the `vector[column_view]` to use a `column_view*` which we then no longer know the lifetime of. This is a bit of a pain for us on the Cython side, but we have a couple of options from my perspective:\r\n1) We add an attribute to our `Column` cython class that keeps a reference to a `vector[column_view]` to keep it alive. Note: this doesn't work when children columns can have children unless we recursively add all of the children `column_view` to the vector.\r\n2) We create a `ColumnView` cython class that keeps a reference to a `vector[column_view]` and a corresponding list of `ColumnView` to handle keeping children of children of children of etc. alive.\r\n\r\nNumber 2 is probably the better long term solution but is a bit of annoying work as of now.","createdAt":"2020-02-27T18:24:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-592106373","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDU5MjExMDEwNQ==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"You'd just need to make [this `vector`](https://github.com/rapidsai/cudf/blob/branch-0.13/python/cudf/cudf/_libxx/column.pyx#L344) stay alive for the lifetime of the Python column object.\r\n\r\nInstead of creating a `column_view` on the fly for a Python column every time you need to pass into libcudf, why not just construct and store the `column_view` once? I think this is what you're suggesting in 2. ","createdAt":"2020-02-27T18:33:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-592110105","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDU5MjExMjQ3Ng==","author":{"login":"kkraus14"},"authorAssociation":"COLLABORATOR","body":"> You'd just need to make [this `vector`](https://github.com/rapidsai/cudf/blob/branch-0.13/python/cudf/cudf/_libxx/column.pyx#L344) stay alive for the lifetime of the Python column object.\r\n\r\nWhat about the `column_view` children of those `column_view`? Nothing would be controlling their lifetime since they'd now be `column_view*`.\r\n\r\n> Instead of creating a column_view on the fly for a Python column every time you need to pass into libcudf, why not just construct and store the column_view once? I think this is what you're suggesting in #2.\r\n\r\nWe'd then need to somehow invalidate that `column_view` whenever we do something potentially mutable, which in the currently state of using legacy things as well is still somewhat all over the place. My initial thought is to basically replace where we call `.view()` currently with something like `view().column_view()` where `.view()` returns a `ColumnView` and `.column_view()` returns the C++ `column_view`, but this can lead to situations where we accidentally create an ephemeral instance of `ColumnView` and then end up with a dangling pointer in the `column_view`.","createdAt":"2020-02-27T18:38:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-592112476","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDU5MjExNTc3OQ==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"Understood that it will require a bit of work.\r\n\r\nIt sounds like the pros still outweigh the cons. Eliminating this pervasive compiler error will be a huge win. So unless it's totally impossible to make this change without significant effort, it still seems like something we should do.\r\n\r\nAnd to be clear, this wouldn't be tackled until post-GTC, 0.14 timeframe. ","createdAt":"2020-02-27T18:45:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"ROCKET","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-592115779","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDU5MzcxMjc0Nw==","author":{"login":"harrism"},"authorAssociation":"MEMBER","body":"I think this is a nice bit if tech debt to tackle in 0.14.","createdAt":"2020-03-03T01:05:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-593712747","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYyMzgwMDU3OA==","author":{"login":"harrism"},"authorAssociation":"MEMBER","body":"@jrhemstad can you document here what you ran up against that lead to reprioritizing this?","createdAt":"2020-05-05T02:18:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-623800578","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc5ODk2MjczNA==","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-90d` due to no recent activity in the past 90 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed.","createdAt":"2021-03-14T19:14:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-798962734","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc5ODk2Mjc0NA==","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-30d` due to no recent activity in the past 30 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed. This issue will be labeled `inactive-90d` if there is no activity in the next 60 days.","createdAt":"2021-03-14T19:14:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-798962744","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc5OTg3MDg5OQ==","author":{"login":"harrism"},"authorAssociation":"MEMBER","body":"This is still relevant. @jrhemstad instead of storing a pointer and size, I guess `column_view` could just store a `host_span<column_view>`?","createdAt":"2021-03-16T01:19:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-799870899","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc5OTg4MDA1Nw==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"> This is still relevant. @jrhemstad instead of storing a pointer and size, I guess `column_view` could just store a `host_span<column_view>`?\r\n\r\nIt could, yeah. I remember I went down the path of making this change (not the `host_span` specifically) and running into what felt like a showstopper. I can't remember what it was right now. I'd have to revisit and think about it. ","createdAt":"2021-03-16T01:46:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/4270#issuecomment-799880057","viewerDidAuthor":false}],"createdAt":"2020-02-27T18:10:01Z","id":"MDU6SXNzdWU1NzIyNjE0ODI=","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMTM5NzQwNjY2","name":"libcudf","description":"Affects libcudf (C++/CUDA) code.","color":"c5def5"}],"milestone":null,"number":4270,"projectCards":[{"project":{"name":"Feature Planning"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Make `column_view` _actually_ be a view","updatedAt":"2024-02-23T18:02:29Z","url":"https://github.com/rapidsai/cudf/issues/4270"}
