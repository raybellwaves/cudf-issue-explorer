{"assignees":[],"author":{"id":"MDQ6VXNlcjQ4Mzc1NzE=","is_bot":false,"login":"VibhuJawa","name":"Vibhu Jawa"},"body":"**Describe the bug**\r\n\r\nIf we have nulls in the column to run aggregate on we, seem to get incorrect results if there are `np.nan` in the column we are aggregating on.    \r\n\r\n\r\n**Steps/Code to reproduce bug**\r\n```python\r\n\r\n>>> import numpy as np\r\n>>> import cudf\r\n>>> df = cudf.DataFrame({'key':[0,0,0],'val':[None,1.1,None]})\r\n>>> df['val']=df.val.fillna(np.nan)\r\n>>> df.groupby(by='key').val.sum()\r\nkey\r\n0   NaN\r\nName: val, dtype: float64\r\n```\r\n\r\n**Expected behavior**\r\n\r\n```python\r\n>>> df.to_pandas().groupby(by='key').val.sum()\r\nkey\r\n0    1.1\r\nName: val, dtype: float64\r\n```\r\n\r\n**Environment details**\r\n```python\r\ncudf                      0.17.0a201119   cuda_10.2_py37_g1a80df96c4_285    rapidsai-nightly\r\nlibcudf                   0.17.0a201119   cuda10.2_g1a80df96c4_285    rapidsai-nightly\r\n```\r\n\r\n**Additional context**\r\nAs a workaround below does the trick. \r\n\r\n```python\r\ndf.nans_to_nulls().groupby(by='key').agg({'val':['sum']})\r\n```\r\n\r\nCC: @beckernick ","closed":false,"closedAt":null,"comments":[{"id":"MDEyOklzc3VlQ29tbWVudDczMTMzMTIyNw==","author":{"login":"kkraus14"},"authorAssociation":"COLLABORATOR","body":"cc @jrhemstad I think this would require an option in libcudf to control `NaN` behavior in groupby aggregations, but I'm not sure what our thoughts are from the libcudf side.","createdAt":"2020-11-20T18:14:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6810#issuecomment-731331227","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDczMTM0MjgyMQ==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"`NaN + x == NaN âˆ€ x` ","createdAt":"2020-11-20T18:40:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6810#issuecomment-731342821","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MDA5NDIzNA==","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been marked stale due to no recent activity in the past 30d. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed. This issue will be marked rotten if there is no activity in the next 60d.","createdAt":"2021-02-16T20:20:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6810#issuecomment-780094234","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MjYzODYzMQ==","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-90d` due to no recent activity in the past 90 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed.","createdAt":"2021-05-17T21:05:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6810#issuecomment-842638631","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5MZCh4","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"@shwina @brandon-b-miller what do we want to do with something like this? I think with a lot of our more recent discussions around NaN and NULL we have been OK accepting this kind of discrepancy based on the fact that we don't conflate the two, right?","createdAt":"2022-10-17T23:38:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6810#issuecomment-1281632376","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5Mclot","author":{"login":"shwina"},"authorAssociation":"CONTRIBUTOR","body":"I don't think this is related to the NaN v/s N/A discussion. Pandas seems to ignore both in groupby reductions:\r\n\r\n```python\r\nIn [86]: df = pd.DataFrame({'key':[0,0,0],'val':[pd.NA, 1, pd.NA]})\r\n\r\nIn [87]: df\r\nOut[87]: \r\n   key   val\r\n0    0  <NA>\r\n1    0     1\r\n2    0  <NA>\r\n\r\nIn [88]: df.groupby('key').sum()\r\nOut[88]: \r\n     val\r\nkey     \r\n0      1\r\n\r\nIn [89]: df = pd.DataFrame({'key':[0,0,0],'val':[np.nan, 1, np.nan]})\r\n\r\nIn [90]: df\r\nOut[90]: \r\n   key  val\r\n0    0  NaN\r\n1    0  1.0\r\n2    0  NaN\r\n\r\nIn [91]: df.groupby('key').sum()\r\nOut[91]: \r\n     val\r\nkey     \r\n0    1.0\r\n```\r\n\r\nFWIW, cuDF _also_ ignore nulls and NaNs for plain (i.e., not grouped) reductions:\r\n\r\n```python\r\nIn [92]: cudf.Series([1, 2, None]).sum()\r\nOut[92]: 3\r\n\r\nIn [93]: cudf.Series([1, 2, np.nan], nan_as_null=False).sum()\r\nOut[93]: 3.0\r\n```\r\n\r\nNote that a `skipna=` kwarg can be used to control null handling in plain reductions:\r\n\r\n```python\r\ncudf.Series([1, 2, None]).sum(skipna=False)\r\nnan\r\n```\r\n\r\n`GroupBy.sum()` (both in Pandas and cuDF) lacks a similar `skipna=` kwarg. In Pandas, you can work around this using a callable aggregation:\r\n\r\n```python\r\ndf.groupby('key').agg(lambda x: x.sum(skipna=False))\r\n```\r\n\r\n---\r\n\r\nHere are a few proposals for how to proceed:\r\n\r\n1. We consider this a bug and change our groupby reduction behaviour to ignore nulls, exactly like Pandas\r\n2. We change nothing, and document the difference in behaviour in our [user guide](https://docs.rapids.ai/api/cudf/stable/user_guide/groupby.html).\r\n3. We introduce a `skipna=` argument to group reductions, allowing the user to control whether or not nulls should be skipped, defaulting to `True` to match Pandas behaviour, and allowing `False` to support cuDF's current behaviour:\r\n\r\n   ```python\r\n   df.groupby('key').sum(skipna=False)\r\n   ```\r\n\r\nWe could also ask if Pandas would be interested in supporting (3).","createdAt":"2022-10-18T15:16:33Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/6810#issuecomment-1282562605","viewerDidAuthor":false}],"createdAt":"2020-11-19T21:09:51Z","id":"MDU6SXNzdWU3NDY5MjYyNzM=","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"MDU6TGFiZWwxMTM5NzQxMjEz","name":"cuDF (Python)","description":"Affects Python cuDF API.","color":"1d76db"}],"milestone":{"number":5,"title":"Pandas API Alignment and Coverage","description":"","dueOn":null},"number":6810,"projectCards":[{"project":{"name":"Bug Squashing"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG]Groupby agg with np.nan in aggregating column leads to incorrect results ","updatedAt":"2024-05-30T00:36:19Z","url":"https://github.com/rapidsai/cudf/issues/6810"}
