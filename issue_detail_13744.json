{"assignees":[],"author":{"id":"MDQ6VXNlcjE1MzgxNjU=","is_bot":false,"login":"vyasr","name":"Vyas Ramasubramani"},"body":"**Is your feature request related to a problem? Please describe.**\r\nCurrently most libcudf APIs operate implicitly on the default CUDA stream. As documented in #925, we would like to expose stream-ordered APIs publicly. Prior to doing so, we needed to do a great deal of work to ensure that libcudf's internals were properly stream-ordered. Among the important tasks here were removing implicit APIs that ran on a stream (see #11968) and implementing a strategy for verifying that streams are properly forwarded from APIs all the way down to the lowest level functions (see #11943). Now that all such work that we are aware of has been completed, libcudf should start exposing streams in public APIs. \r\n\r\nWe originally considered adding stream support via a monolithic feature branch where APIs would be modified one at a time. From various discussions, however, we decided that the overhead of maintaining a feature branch would grow too large to be worthwhile, so we have instead decided to proceed by incrementally exposing streams in libcudf APIs over time. PRs adding new APIs should always include a stream in the public API. Existing APIs will be transitioned one header file at a time, with PRs going directly into the current main branch of cudf.\r\n\r\nThe purpose of this PR is to document progress on the task of transitioning existing headers, as well as to describe the process by which new stream-ordered APIs should be added.\r\n\r\n**Describe the solution you'd like**\r\nWhen adding stream support to an API, the stream parameter should be placed just before the mr parameter with a default value of `cudf::get_default_stream()`. A new test should be added that validates that the API properly forwards the stream to all CUDA calls, which can be done by following the instructions at the bottom of [libcudf's testing developer docs](https://docs.rapids.ai/api/libcudf/nightly/md_developer_guide_testing). \r\n\r\nTo divide up the work, we consider public headers organized by directories (all relative to `cpp/include/cudf`). Devs may assign themselves a directory within which to own all headers and the public APIs contained therein.\r\n\r\n| Directory | Source <br> files (#) | PRs | Details |\r\n|---|---|---|---|\r\n| cudf/ | 28 |  hashing #12090, copying #13629, concatenate #13987, filling #13990, replace #14010, search #14034, sorting #14146, null mask #14263, unary #14342 | owner: @vyasr |\r\n| cudf/ast/          | 1 | | |\r\n| cudf/column/  | 4 |  factories #14354  | |\r\n| cudf/dictionary/ | 5 | encode + search + update_keys #14115 | |\r\n| cudf/fixed_point/ | 2 | | |\r\n| cudf/io/ | 16 | csv #14340, json #14313, pq #14359, orc #14350  | See \"text\" request in #14383 |\r\n| cudf/labeling/ | 1 | #14401 |  |\r\n| cudf/lists/ | 15 | combine + contains + count #14248, extract + sort + compact + reverse + gather #14272 | |\r\n| nvtext/ | 11 | ngram #14061, replace #14329, tokenize #14317, edit #14456 | owner: @davidwendt |\r\n| cudf/rolling/ | 1 | | |\r\n| cudf/scalar/ | 3 |   | See for scalar refactoring work #14354 |\r\n| cudf/strings/ | 37 | split #13997, #14247, find #14060, case #14056, replace #14261, convert #14255, filter #14293, contains #14280, combine #14281, misc #14260 | owner: @davidwendt  | \r\n| cudf/structs/ | 3 | | |\r\n| cudf/table/ | 5 | | |\r\n| cudf/tdigest/ | 1 | | |\r\n| cudf/utilities/ | 9 | | |\r\n| cudf/wrappers/ | 3 | | |\r\n\r\n\r\n\r\n\r\n**Additional context**\r\nBefore we began making public stream parameters, libcudf public APIs would be paired with detail APIs that are nearly identical except for having a required stream parameter. In some cases, though, the public API may not currently have a detail \"mirror\" function but instead call multiple detail APIs. In those cases we may need to make a case-by-case determination of whether a new detail function should also be added. Some discussion of whether we want this pattern to be present everywhere, and the reasons why we might want that, are discussed in #14276.\r\n\r\nPublic stream API readiness:\r\n* revamp the entire test suite to use \"test streams\"\r\n* create a few multi-stream benchmarks\r\n* create a multi-stream example","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5sEymd","author":{"login":"ZelboK"},"authorAssociation":"CONTRIBUTOR","body":"Hi, \r\n\r\nI took a look yesterday and from what I saw the API for the column headers already expose the cuda stream in the API. However I do not see a direct test for it. ","createdAt":"2023-11-15T20:13:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/13744#issuecomment-1813195165","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5sE18B","author":{"login":"davidwendt"},"authorAssociation":"CONTRIBUTOR","body":"> I took a look yesterday and from what I saw the API for the column headers already expose the cuda stream in the API. However I do not see a direct test for it.\r\n\r\nThe stream tests are located here: https://github.com/rapidsai/cudf/tree/branch-23.12/cpp/tests/streams\r\nIt is certainly possible we missed some tests. Which APIs did you find that are missing tests?","createdAt":"2023-11-15T20:24:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/13744#issuecomment-1813208833","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5sE_AR","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"There are a small set of APIs that had streams added before we made the current push for adding streams, largely in cases where cuspatial needed them. Those predate the stream testing. We would welcome adding stream testing for those APIs if you find missing ones!","createdAt":"2023-11-15T20:53:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/13744#issuecomment-1813245969","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5t_-vu","author":{"login":"karthikeyann"},"authorAssociation":"CONTRIBUTOR","body":"Source code of groupby should be updated to use stream from top level APIs.\r\nhttps://github.com/rapidsai/cudf/pull/14354#discussion_r1384175665\r\nRelated https://github.com/rapidsai/cudf/issues/11463  https://github.com/rapidsai/cudf/issues/13737\r\n","createdAt":"2023-12-07T14:54:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/13744#issuecomment-1845488622","viewerDidAuthor":false}],"createdAt":"2023-07-24T22:34:38Z","id":"I_kwDOBWUGps5sb4B_","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMDEzOTg3NTAz","name":"2 - In Progress","description":"Currently a work in progress","color":"fef2c0"},{"id":"MDU6TGFiZWwxMTM5NzQwNjY2","name":"libcudf","description":"Affects libcudf (C++/CUDA) code.","color":"c5def5"}],"milestone":{"number":19,"title":"Enable streams","description":"Enable safe usage of a stream-ordered libcudf API","dueOn":null},"number":13744,"projectCards":[],"projectItems":[],"reactionGroups":[{"content":"ROCKET","users":{"totalCount":2}}],"state":"OPEN","title":"[FEA] Expose public stream-ordered C++ APIs","updatedAt":"2024-03-09T15:48:19Z","url":"https://github.com/rapidsai/cudf/issues/13744"}
