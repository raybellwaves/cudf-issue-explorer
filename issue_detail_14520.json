{"assignees":[],"author":{"id":"MDQ6VXNlcjExNjY0MjU5","is_bot":false,"login":"galipremsagar","name":"GALI PREM SAGAR"},"body":"When we've already imported cuDF, the Ipython magic `%reset -f --aggressive` is no longer enough to clear the environment/sys modules of all pandas objects so that we can `%load_ext cudf.pandas` and use cuDF under the hood,\r\n\r\n```python\r\n\r\nIn [1]: import cudf\r\n\r\nIn [2]: %reset -f --aggressive\r\nculling sys module...\r\n\r\nIn [3]: %load_ext cudf.pandas\r\n/nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/numba/__init__.py:34: UserWarning: The NumPy module was reloaded (imported a second time). This can in some cases result in small but subtle issues and is discouraged.\r\n  import numpy as np\r\n---------------------------------------------------------------------------\r\nArrowKeyError                             Traceback (most recent call last)\r\nCell In[3], line 1\r\n----> 1 get_ipython().run_line_magic('load_ext', 'cudf.pandas')\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/IPython/core/interactiveshell.py:2456, in InteractiveShell.run_line_magic(self, magic_name, line, _stack_depth)\r\n   2454     kwargs['local_ns'] = self.get_local_scope(stack_depth)\r\n   2455 with self.builtin_trap:\r\n-> 2456     result = fn(*args, **kwargs)\r\n   2458 # The code below prevents the output from being displayed\r\n   2459 # when using magics with decorator @output_can_be_silenced\r\n   2460 # when the last Python token in the expression is a ';'.\r\n   2461 if getattr(fn, magic.MAGIC_OUTPUT_CAN_BE_SILENCED, False):\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/IPython/core/magics/extension.py:33, in ExtensionMagics.load_ext(self, module_str)\r\n     31 if not module_str:\r\n     32     raise UsageError('Missing module name.')\r\n---> 33 res = self.shell.extension_manager.load_extension(module_str)\r\n     35 if res == 'already loaded':\r\n     36     print(\"The %s extension is already loaded. To reload it, use:\" % module_str)\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/IPython/core/extensions.py:76, in ExtensionManager.load_extension(self, module_str)\r\n     69 \"\"\"Load an IPython extension by its module name.\r\n     70 \r\n     71 Returns the string \"already loaded\" if the extension is already loaded,\r\n     72 \"no load function\" if the module doesn't have a load_ipython_extension\r\n     73 function, or None if it succeeded.\r\n     74 \"\"\"\r\n     75 try:\r\n---> 76     return self._load_extension(module_str)\r\n     77 except ModuleNotFoundError:\r\n     78     if module_str in BUILTINS_EXTS:\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/IPython/core/extensions.py:91, in ExtensionManager._load_extension(self, module_str)\r\n     89 with self.shell.builtin_trap:\r\n     90     if module_str not in sys.modules:\r\n---> 91         mod = import_module(module_str)\r\n     92     mod = sys.modules[module_str]\r\n     93     if self._call_load_ipython_extension(mod):\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/importlib/__init__.py:126, in import_module(name, package)\r\n    124             break\r\n    125         level += 1\r\n--> 126 return _bootstrap._gcd_import(name[level:], package, level)\r\n\r\nFile <frozen importlib._bootstrap>:1050, in _gcd_import(name, package, level)\r\n\r\nFile <frozen importlib._bootstrap>:1027, in _find_and_load(name, import_)\r\n\r\nFile <frozen importlib._bootstrap>:992, in _find_and_load_unlocked(name, import_)\r\n\r\nFile <frozen importlib._bootstrap>:241, in _call_with_frames_removed(f, *args, **kwds)\r\n\r\nFile <frozen importlib._bootstrap>:1050, in _gcd_import(name, package, level)\r\n\r\nFile <frozen importlib._bootstrap>:1027, in _find_and_load(name, import_)\r\n\r\nFile <frozen importlib._bootstrap>:1006, in _find_and_load_unlocked(name, import_)\r\n\r\nFile <frozen importlib._bootstrap>:688, in _load_unlocked(spec)\r\n\r\nFile <frozen importlib._bootstrap_external>:883, in exec_module(self, module)\r\n\r\nFile <frozen importlib._bootstrap>:241, in _call_with_frames_removed(f, *args, **kwds)\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/cudf/__init__.py:19\r\n     16 from rmm.allocators.cupy import rmm_cupy_allocator\r\n     17 from rmm.allocators.numba import RMMNumbaManager\r\n---> 19 from cudf import api, core, datasets, testing\r\n     20 from cudf._version import __git_commit__, __version__\r\n     21 from cudf.api.extensions import (\r\n     22     register_dataframe_accessor,\r\n     23     register_index_accessor,\r\n     24     register_series_accessor,\r\n     25 )\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/cudf/api/__init__.py:3\r\n      1 # Copyright (c) 2021, NVIDIA CORPORATION.\r\n----> 3 from cudf.api import extensions, types\r\n      5 __all__ = [\"extensions\", \"types\"]\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/cudf/api/types.py:18\r\n     15 from pandas.api import types as pd_types\r\n     17 import cudf\r\n---> 18 from cudf.core.dtypes import (  # noqa: F401\r\n     19     _BaseDtype,\r\n     20     dtype,\r\n     21     is_categorical_dtype,\r\n     22     is_decimal32_dtype,\r\n     23     is_decimal64_dtype,\r\n     24     is_decimal128_dtype,\r\n     25     is_decimal_dtype,\r\n     26     is_interval_dtype,\r\n     27     is_list_dtype,\r\n     28     is_struct_dtype,\r\n     29 )\r\n     32 def is_numeric_dtype(obj):\r\n     33     \"\"\"Check whether the provided array or dtype is of a numeric dtype.\r\n     34 \r\n     35     Parameters\r\n   (...)\r\n     43         Whether or not the array or dtype is of a numeric dtype.\r\n     44     \"\"\"\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/cudf/core/dtypes.py:28\r\n     25 from cudf.utils.docutils import doc_apply\r\n     27 if PANDAS_GE_150:\r\n---> 28     from pandas.core.arrays.arrow.extension_types import ArrowIntervalType\r\n     29 else:\r\n     30     from pandas.core.arrays._arrow_utils import ArrowIntervalType\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/pandas/core/arrays/arrow/extension_types.py:49\r\n     47 # register the type with a dummy instance\r\n     48 _period_type = ArrowPeriodType(\"D\")\r\n---> 49 pyarrow.register_extension_type(_period_type)\r\n     52 class ArrowIntervalType(pyarrow.ExtensionType):\r\n     53     def __init__(self, subtype, closed: IntervalClosedType) -> None:\r\n     54         # attributes need to be set first before calling\r\n     55         # super init (as that calls serialize)\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/pyarrow/types.pxi:1836, in pyarrow.lib.register_extension_type()\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/pyarrow/error.pxi:91, in pyarrow.lib.check_status()\r\n\r\nArrowKeyError: A type extension with name pandas.period already defined\r\n```\r\n\r\nInstead, we need to explicitly restart the kernel to use `cudf.pandas` , which we can do via in IPython via `get_ipython().kernel.do_shutdown(restart=True)`.\r\n\r\nThis isn't a big deal, as we shouldn't rely on this kind of `reset` based behavior anyway. But, I believe this is a change in behavior and we may want to look into it down the road.","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5tUON8","author":{"login":"wence-"},"authorAssociation":"CONTRIBUTOR","body":"This will never work since culling things from sys.modules does not `dlclose` the compiled extension modules that were loaded, so any state that is maintained in these shared libraries will persist.","createdAt":"2023-11-30T15:37:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14520#issuecomment-1834017660","viewerDidAuthor":false}],"createdAt":"2023-11-28T19:49:04Z","id":"I_kwDOBWUGps54HVvi","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"MDU6TGFiZWwxMTM5NzQxMjEz","name":"cuDF (Python)","description":"Affects Python cuDF API.","color":"1d76db"},{"id":"LA_kwDOBWUGps8AAAABlj4eYg","name":"cudf.pandas","description":"Issues specific to cudf.pandas","color":"984DFB"}],"milestone":{"number":36,"title":"cudf.pandas API coverage","description":"","dueOn":null},"number":14520,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG] IPython magic reset does not always sufficiently clear pandas objects to enable using cuDF via `cudf.pandas`","updatedAt":"2024-05-16T05:09:17Z","url":"https://github.com/rapidsai/cudf/issues/14520"}
