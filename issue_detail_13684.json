{"assignees":[],"author":{"id":"MDQ6VXNlcjEwOTk1NzYy","is_bot":false,"login":"paleolimbot","name":"Dewey Dunnington"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nI wish I could use the `filter` argument of `cudf.read_parquet()` on nested columns. The in-progress GeoArrow specification is considering allowing a `struct<x: double, y: double>` coordinate representation which provides out-of-the-box column statistics for the inner `x` and `y`. Linestrings, polygons, and multipolygons involve layers of `list<>` nesting that still produce column statistics for the coordinates that would be nice to use with a bounding box filter (see example below).\r\n\r\n**Describe the solution you'd like**\r\n\r\nIt would be nice if the left-hand side of a filter expression could be a tuple instead of a string to specify a nested field. I imagine the nested field of a list is more complicated here but even a nested struct field would be helpful.\r\n\r\n**Describe alternatives you've considered**\r\n\r\nThe current workaround I've used is to flatten the fields before writing the parquet. This is OK but looses the extension type metadata (e.g., CRS) and doesn't scale to the nested types (e.g., linestring, polygon, multipolygon).\r\n\r\n**Additional context**\r\n\r\nA small illustration with some test data:\r\n\r\n```python\r\n>>> import pyarrow as pa\r\n>>> import pyarrow.parquet as pq\r\n>>> \r\n>>> \r\n>>> xs = pa.array([0.0, 1.0, 2.0, 3.0])\r\n>>> ys = pa.array([1.0, 2.0, 3.0, 4.0])\r\n>>> xys = pa.array([\r\n...     {\"x\": 0.0, \"y\": 1.0}, \r\n...     {\"x\": 1.0, \"y\": 2.0}, \r\n...     {\"x\": 2.0, \"y\": 3.0}, \r\n...     {\"x\": 3.0, \"y\": 4.0}, \r\n... ])\r\n>>> table = pa.table([xs, ys, xys], names=[\"x\", \"y\", \"xy\"])\r\n>>> pq.write_table(table, \"test.parquet\")\r\n>>> \r\n>>> # Works!\r\n>>> bounds = [0.5, 1.5, 2.5, 3.5]\r\n>>> cudf.read_parquet(\r\n...     \"test.parquet\",\r\n...     filters=[\r\n...         [\r\n...             ('x', '>=', bounds[0]),\r\n...             ('y', '>=', bounds[1]),\r\n...             ('x', '<=', bounds[2]),\r\n...             ('y', '<=', bounds[3])\r\n...         ]\r\n...     ]\r\n... )\r\n     x    y                    xy\r\n0  1.0  2.0  {'x': 1.0, 'y': 2.0}\r\n1  2.0  3.0  {'x': 2.0, 'y': 3.0}\r\n>>> \r\n>>> # Doesn't work:\r\n>>> cudf.read_parquet(\r\n...     \"test.parquet\",\r\n...     filters=[\r\n...         [\r\n...             (('xy', 'x'), '>=', bounds[0]),\r\n...             (('xy', 'y'), '>=', bounds[1]),\r\n...             (('xy', 'x'), '<=', bounds[2]),\r\n...             (('xy', 'y'), '<=', bounds[3])\r\n...         ]\r\n...     ]\r\n... )\r\n.conda/lib/python3.10/site-packages/cudf/io/parquet.py:674: UserWarning: Row-wise filtering failed in read_parquet for [[(('xy', 'x'), '>=', 0.5), (('xy', 'y'), '>=', 1.5), (('xy', 'x'), '<=', 2.5), (('xy', 'y'), '<=', 3.5)]]\r\n  warnings.warn(\r\n     x    y                    xy\r\n0  0.0  1.0  {'x': 0.0, 'y': 1.0}\r\n1  1.0  2.0  {'x': 1.0, 'y': 2.0}\r\n2  2.0  3.0  {'x': 2.0, 'y': 3.0}\r\n3  3.0  4.0  {'x': 3.0, 'y': 4.0}\r\n```\r\n","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5iJh26","author":{"login":"GregoryKimball"},"authorAssociation":"CONTRIBUTOR","body":"Thank you @paleolimbot for your request. We've taken the approach to use libcudf ASTs for processing `read_parquet` filters. We could extend the existing approach to flatten/extract nested types, or perhaps even expand the type support for ASTs. Once we stabilize our IO filtering improvements we will revisit this request.","createdAt":"2023-07-22T20:23:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/13684#issuecomment-1646665146","viewerDidAuthor":false}],"createdAt":"2023-07-11T01:39:09Z","id":"I_kwDOBWUGps5rKglK","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMDEzOTg3MzUy","name":"0 - Backlog","description":"In queue waiting for assignment","color":"d4c5f9"},{"id":"MDU6TGFiZWwxMTM5NzQwNjY2","name":"libcudf","description":"Affects libcudf (C++/CUDA) code.","color":"c5def5"},{"id":"MDU6TGFiZWwxMTg1MjQ0MTQy","name":"cuIO","description":"cuIO issue","color":"fef2c0"}],"milestone":{"number":21,"title":"Expression evaluation","description":"","dueOn":null},"number":13684,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Support nested fields for `filter` in `cudf.read_parquet()`","updatedAt":"2024-02-16T23:28:28Z","url":"https://github.com/rapidsai/cudf/issues/13684"}
