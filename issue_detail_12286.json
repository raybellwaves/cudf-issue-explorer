{"assignees":[],"author":{"id":"MDQ6VXNlcjIzMTIwODM3","is_bot":false,"login":"arpan-das-astrophysics","name":"Arpan Das"},"body":"I am trying to extract the some columns of a cudf dataframe \r\n\r\n```\r\n%%time\r\ncudf_file = \"/work/ska/cudfoutput/lofar30MHz1_t201806301100_SBL153.parquet\"\r\ndf = cudf.read_parquet(cudf_file, columns =['TIME','ANTENNA1','ANTENNA2','FLAG','DATA'])\r\ndf3 = df.loc[df['TIME'].isin(unique_time)]\r\nfor t in unique_time:   \r\n    df2 = df3[df3.TIME == t]\r\n    beam_id_0_cp = cp.asarray(df2['ANTENNA1'])\r\n    beam_id_1_cp = cp.asarray(df2['ANTENNA2'])\r\n    dfflag = df2['FLAG']\r\n    data_flag_cp = cp.asarray(dfflag.list.leaves).reshape(len(dfflag),len(dfflag.iloc[0]),len(dfflag.iloc[0][0]))\r\n    dfdata = df2['DATA']\r\n    data_cp = cp.asarray(dfdata.list.leaves, dtype=np.float64).reshape(len(dfdata),len(dfdata.iloc[0]),len(dfdata.iloc[0][0])).view(np.complex128)\r\n   ```\r\n\r\nThe scaling becomes worse if we have a bigger loop (>1000 steps), for smaller timesteps it is the faster but as we go higher the scaling is becoming an issue. However, I am wondering why as I am not reading the dataframe inside the loop. Is there a better way to do this? I have tried groupby as well and the results are similar","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5PnM0L","author":{"login":"shwina"},"authorAssociation":"CONTRIBUTOR","body":"@arpan-das-astrophysics - any chance you're able to provide a minimal reproducer of the issue? The snippet you posted above cannot be run in isolation as it depends on prior code and external data.\r\n","createdAt":"2022-12-02T18:51:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/12286#issuecomment-1335676171","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5RMO_0","author":{"login":"GregoryKimball"},"authorAssociation":"CONTRIBUTOR","body":"Thanks @arpan-das-astrophysics for sharing this use case. Would you please tell me a bit more about the data?\r\n* how many rows does `df2` typically contain after the filter on `df3.TIME == t`?\r\n* Can you reuse the `reshape` parameters (`len(dfflag),len(dfflag.iloc[0]),len(dfflag.iloc[0][0])`) between times or must it be computed for each value `t`?\r\n* how expensive is the `view` function?\r\n\r\nI suspect that poor scaling would be caused by looping over unique times instead of processing the full dataframe. \r\n\r\nHere was my sample data to study your example:\r\n```\r\ndf = cudf.DataFrame()\r\ndf['TIME'] = [0,0,0,1,1,1,2,2,2,3]\r\nunique_time = [1,2]\r\ndf['ANTENNA1'] = [[1,2,3]] * 10\r\ndf['ANTENNA2'] = [[1,2,3]] * 10\r\ndf['FLAG'] = [[[0,1],[1,0]]] * 10\r\ndf['DATA'] = [[[0,1],[1,0]]] * 10\r\n```\r\n","createdAt":"2022-12-21T22:01:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/12286#issuecomment-1362161652","viewerDidAuthor":false}],"createdAt":"2022-12-02T11:13:41Z","id":"I_kwDOBWUGps5Xx6Rg","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjQ=","name":"question","description":"Further information is requested","color":"D4C5F9"},{"id":"MDU6TGFiZWwxMDEzOTg3Nzk5","name":"0 - Waiting on Author","description":"Waiting for author to respond to review","color":"ffb88c"}],"milestone":null,"number":12286,"projectCards":[{"project":{"name":"Other Issues"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"Poor scaling for larger query/loc with cudf Dataframe[QST]","updatedAt":"2022-12-21T22:01:49Z","url":"https://github.com/rapidsai/cudf/issues/12286"}
