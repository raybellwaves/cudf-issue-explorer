{"assignees":[{"id":"MDQ6VXNlcjE2MDA1Njkw","login":"vuule","name":"Vukasin Milovanovic"}],"author":{"id":"MDQ6VXNlcjM0NDEzMjE=","is_bot":false,"login":"revans2","name":"Robert (Bobby) Evans"},"body":"**Describe the bug**\r\nThis is directly from https://github.com/NVIDIA/spark-rapids/issues/6435 If you have a field like `abc\"\"` in a CSV file the cudf CSV parser stops processing more data.\r\n\r\n**Steps/Code to reproduce bug**\r\nCreate a file `test.csv` with the following data in it.\r\n\r\n```\r\n134324937434,#1991 N Grayhawk,\"\",Menlo Park,89025,AB,United States,US\r\n208564744937,\"63,trevion Way\",\"\",st Lothian,h7f4h8,\"\",United Kingdom,GB\r\n132709376823,16 Oakland PARK RD,\"\",ring,l1w1e4,South,Canada,CA\r\n224867848652,7 kingwell Court,\"\",United,s7jd9,South United,United Kingdom,GB\r\n169636884295,30 cartuja Road,\"\",Halifax,L0R 9p2,ON,Canada,CA\r\n859473321609,Street,\"\",Manchester,92220,OR,United States,US\r\n141096112545,99 rue des,\"\",Australia,jsd9je,\"\",France,FR\r\n160397658930,5 Rise,\"\",walligshngton,RY6 8LT,FORT,United Kingdom,GB\r\n726367494002,1852 Townsend st,666,Wallsend,90382,CA,United States,US\r\n187644735867,B채rbel-HAMPDEN-Ping 37,\"\",Miami,13355,\"\",Kingdom,ZZ\r\n948475348324,155 sw City ct,Rochdale,Germany,30864,FL,Australia,QQ\r\n164083193213,abc\"\",\"\",Jerez Fra.,11401,Cadiz,Spain,ES\r\n198732413077,3p Grove Rochdale road,BAW,Fulifax,HX4 trW,\"\",Israel,GB\r\n227433927227,95 novem blvd,\"\",RAW VILLAGE,3173,XYZ,Australia,IL\r\n```\r\n\r\nNow try to read it using CUDF.  The last two rows are skipped, and the `acb\"\"` is read back missing the last `\"`\r\n\r\n(From spark using the rapids plugin for apache spark)\r\n\r\n```\r\n+------------+--------------------+--------+-------------+-------+------------+--------------+---+\r\n|         _c0|                 _c1|     _c2|          _c3|    _c4|         _c5|           _c6|_c7|\r\n+------------+--------------------+--------+-------------+-------+------------+--------------+---+\r\n|134324937434|    #1991 N Grayhawk|    null|   Menlo Park|  89025|          AB| United States| US|\r\n|208564744937|      63,trevion Way|    null|   st Lothian| h7f4h8|        null|United Kingdom| GB|\r\n|132709376823|  16 Oakland PARK RD|    null|         ring| l1w1e4|       South|        Canada| CA|\r\n|224867848652|    7 kingwell Court|    null|       United|  s7jd9|South United|United Kingdom| GB|\r\n|169636884295|     30 cartuja Road|    null|      Halifax|L0R 9p2|          ON|        Canada| CA|\r\n|859473321609|              Street|    null|   Manchester|  92220|          OR| United States| US|\r\n|141096112545|          99 rue des|    null|    Australia| jsd9je|        null|        France| FR|\r\n|160397658930|              5 Rise|    null|walligshngton|RY6 8LT|        FORT|United Kingdom| GB|\r\n|726367494002|    1852 Townsend st|     666|     Wallsend|  90382|          CA| United States| US|\r\n|187644735867|B채rbel-HAMPDEN-Pi...|    null|        Miami|  13355|        null|       Kingdom| ZZ|\r\n|948475348324|      155 sw City ct|Rochdale|      Germany|  30864|          FL|     Australia| QQ|\r\n|164083193213|                abc\"|    null|   Jerez Fra.|  11401|       Cadiz|         Spain| ES|\r\n+------------+--------------------+--------+-------------+-------+------------+--------------+---+\r\n```\r\n\r\nWithout the plugin I get back\r\n```\r\n+------------+--------------------+--------+-------------+-------+------------+--------------+---+\r\n|         _c0|                 _c1|     _c2|          _c3|    _c4|         _c5|           _c6|_c7|\r\n+------------+--------------------+--------+-------------+-------+------------+--------------+---+\r\n|134324937434|    #1991 N Grayhawk|    null|   Menlo Park|  89025|          AB| United States| US|\r\n|208564744937|      63,trevion Way|    null|   st Lothian| h7f4h8|        null|United Kingdom| GB|\r\n|132709376823|  16 Oakland PARK RD|    null|         ring| l1w1e4|       South|        Canada| CA|\r\n|224867848652|    7 kingwell Court|    null|       United|  s7jd9|South United|United Kingdom| GB|\r\n|169636884295|     30 cartuja Road|    null|      Halifax|L0R 9p2|          ON|        Canada| CA|\r\n|859473321609|              Street|    null|   Manchester|  92220|          OR| United States| US|\r\n|141096112545|          99 rue des|    null|    Australia| jsd9je|        null|        France| FR|\r\n|160397658930|              5 Rise|    null|walligshngton|RY6 8LT|        FORT|United Kingdom| GB|\r\n|726367494002|    1852 Townsend st|     666|     Wallsend|  90382|          CA| United States| US|\r\n|187644735867|B채rbel-HAMPDEN-Pi...|    null|        Miami|  13355|        null|       Kingdom| ZZ|\r\n|948475348324|      155 sw City ct|Rochdale|      Germany|  30864|          FL|     Australia| QQ|\r\n|164083193213|               abc\"\"|    null|   Jerez Fra.|  11401|       Cadiz|         Spain| ES|\r\n|198732413077|3p Grove Rochdale...|     BAW|      Fulifax|HX4 trW|        null|        Israel| GB|\r\n|227433927227|       95 novem blvd|    null|  RAW VILLAGE|   3173|         XYZ|     Australia| IL|\r\n+------------+--------------------+--------+-------------+-------+------------+--------------+---+\r\n```\r\n\r\nWhich is also what I get back from pandas.\r\n\r\n```\r\n>>> pd.read_csv(\"./test.csv\", header=None)\r\n               0                       1         2              3        4             5               6   7\r\n0   134324937434        #1991 N Grayhawk       NaN     Menlo Park    89025            AB   United States  US\r\n1   208564744937          63,trevion Way       NaN     st Lothian   h7f4h8           NaN  United Kingdom  GB\r\n2   132709376823      16 Oakland PARK RD       NaN           ring   l1w1e4         South          Canada  CA\r\n3   224867848652        7 kingwell Court       NaN         United    s7jd9  South United  United Kingdom  GB\r\n4   169636884295         30 cartuja Road       NaN        Halifax  L0R 9p2            ON          Canada  CA\r\n5   859473321609                  Street       NaN     Manchester    92220            OR   United States  US\r\n6   141096112545              99 rue des       NaN      Australia   jsd9je           NaN          France  FR\r\n7   160397658930                  5 Rise       NaN  walligshngton  RY6 8LT          FORT  United Kingdom  GB\r\n8   726367494002        1852 Townsend st       666       Wallsend    90382            CA   United States  US\r\n9   187644735867  B채rbel-HAMPDEN-Ping 37       NaN          Miami    13355           NaN         Kingdom  ZZ\r\n10  948475348324          155 sw City ct  Rochdale        Germany    30864            FL       Australia  QQ\r\n11  164083193213                   abc\"\"       NaN     Jerez Fra.    11401         Cadiz           Spain  ES\r\n12  198732413077  3p Grove Rochdale road       BAW        Fulifax  HX4 trW           NaN          Israel  GB\r\n13  227433927227           95 novem blvd       NaN    RAW VILLAGE     3173           XYZ       Australia  IL\r\n```\r\n\r\n**Expected behavior**\r\nCUDF returns the same result as Pandas and Spark.","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5Mn8I-","author":{"login":"revans2"},"authorAssociation":"CONTRIBUTOR","body":"I was able to make the test case a lot simpler and still see the same error.\r\n\r\n```\r\n1\r\n2\r\nacb\"\"\r\n4\r\n5\r\n```\r\n\r\nshows the same problems, only the first three lines come out, and the third entry is only `abc\"`, it is missing the final `\"`","createdAt":"2022-10-20T13:26:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11948#issuecomment-1285538366","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5MoEXT","author":{"login":"revans2"},"authorAssociation":"CONTRIBUTOR","body":"Wow, even if I escape the quotes I still get the problem with the lines, but it \"fixes\" the issue with the quote at the end being removed, but it does not remove the escapes from the quotes.\r\n\r\n```\r\n1\r\n2\r\n\"abc\\\"\\\"\"\r\n4\r\n5\r\n```\r\n\r\nBut the output is \r\n\r\n```\r\n+-------+\r\n|    _c0|\r\n+-------+\r\n|      1|\r\n|      2|\r\n|abc\\\"\\\"|\r\n+-------+\r\n```\r\n\r\nwhen it should be \r\n\r\n```\r\n+-----+\r\n|  _c0|\r\n+-----+\r\n|    1|\r\n|    2|\r\n|abc\"\"|\r\n|    4|\r\n|    5|\r\n+-----+\r\n```\r\n\r\nOddly if I remove the escapes and just keep the entire thing quoted.\r\n\r\n```\r\n1\r\n2\r\n\"abc\"\"\"\r\n4\r\n5\r\n```\r\n\r\nIt fixes the problem with dropping lines, but it does not fix the single entry.\r\n```\r\n+----+\r\n| _c0|\r\n+----+\r\n|   1|\r\n|   2|\r\n|abc\"|\r\n|   4|\r\n|   5|\r\n+----+\r\n```\r\nvs from spark\r\n\r\n```\r\n+-----+\r\n|  _c0|\r\n+-----+\r\n|    1|\r\n|    2|\r\n|abc\"\"|\r\n|    4|\r\n|    5|\r\n+-----+\r\n```\r\n\r\nThis one I am less sure that we have to match exactly what Spark is doing, because pandas matches CUDF in this case. Also pandas does different things for escaped quotes too, so just take these as info for now.","createdAt":"2022-10-20T13:45:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/11948#issuecomment-1285572051","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5MurH6","author":{"login":"GregoryKimball"},"authorAssociation":"CONTRIBUTOR","body":"Thanks @revans2 for investigating this. I'm posting a python reproducer:\r\n```\r\n>>> s = '1\\n2\\nabc\"\"\\n4\\n5'\r\n>>> pd.read_csv(StringIO(s), header=None)\r\n       0\r\n0      1\r\n1      2\r\n2  abc\"\"\r\n3      4\r\n4      5\r\n>>> cudf.read_csv(StringIO(s), header=None)\r\n      0\r\n0     1\r\n1     2\r\n2  abc\"\r\n```","createdAt":"2022-10-21T18:27:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11948#issuecomment-1287303674","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5NbaG_","author":{"login":"vuule"},"authorAssociation":"CONTRIBUTOR","body":"I can't repro the issue in the comment. Trying using Python:\r\n`s = '1\\n2\\n\"abc\\\"\\\"\"\\n4\\n'`\r\nBut I'm getting the same output as with Pandas (and it looks correct):\r\n```\r\n      1\r\n0     2\r\n1  abc\"\r\n2     4\r\n```","createdAt":"2022-11-01T19:45:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11948#issuecomment-1299030463","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5kNzfF","author":{"login":"vuule"},"authorAssociation":"CONTRIBUTOR","body":"Did some scoping and it seems like this requires large changes in the way the reader finds row offsets. Current state machine has four states (represented by two bits) and handling this would require an additional state, and thus more bits. My main concern is with the work involved to change the way state machine packs and handles the states.","createdAt":"2023-08-16T22:18:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11948#issuecomment-1681340357","viewerDidAuthor":false}],"createdAt":"2022-10-19T20:45:58Z","id":"I_kwDOBWUGps5UX8qv","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"MDU6TGFiZWwxMDEzOTg3MzUy","name":"0 - Backlog","description":"In queue waiting for assignment","color":"d4c5f9"},{"id":"MDU6TGFiZWwxMTM5NzQwNjY2","name":"libcudf","description":"Affects libcudf (C++/CUDA) code.","color":"c5def5"},{"id":"MDU6TGFiZWwxMTg1MjQ0MTQy","name":"cuIO","description":"cuIO issue","color":"fef2c0"},{"id":"MDU6TGFiZWwxNDA1MTQ2OTc1","name":"Spark","description":"Functionality that helps Spark RAPIDS","color":"7400ff"}],"milestone":{"number":12,"title":"CSV continuous improvement","description":"","dueOn":null},"number":11948,"projectCards":[{"project":{"name":"Bug Squashing"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG] CSV reader cannot handle unquoted quote character appearing in a field","updatedAt":"2023-08-16T22:18:17Z","url":"https://github.com/rapidsai/cudf/issues/11948"}
