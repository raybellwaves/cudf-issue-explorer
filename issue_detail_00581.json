{"assignees":[],"author":{"id":"MDQ6VXNlcjE1MjIxMjg5","is_bot":false,"login":"jrhemstad","name":"Jake Hemstad"},"body":"<!--\r\n\r\nThanks for opening an issue! To help the libGDF team handle your information\r\nefficiently, please first ensure that there is no other issue present that\r\nalready describes the issue you have\r\n(search at https://github.com/gpuopenanalytics/libgdf/issues?&q=is%3Aissue).\r\n\r\nIf there is no issue present please jump to a section below and delete the\r\nirrelevant one depending on whether you are:\r\n\r\n * Making a feature request.\r\n * Reporting a bug.\r\n\r\nFor more general \"how do I do X?\" type questions, please speak visit\r\nhttp://gpuopenanalytics.com/#/COMMUNITY for links to Slack and Google\r\nGroups.\r\n\r\n-->\r\n\r\n## Feature request\r\n\r\n<!--\r\n\r\nPlease include details of the feature you would like to see, why you would\r\nlike to see it/the use case\r\n\r\n-->\r\n\r\n\r\nAs anyone who has built libgdf recently has surely noticed, the time to compile the library from scratch has grown significantly in the last few months. For example, compiling on all 10 cores of my i9-7900X  @ 3.30GHz takes 11 minutes as reported by `time make -j`.\r\n\r\nCompiling with `-ftime-report` may be a good place to start to see where all the compilation time is being spent.\r\n\r\nThis is likely due to the large amount of template instantiation that is required for instantiating functions for all possible types. We should make sure that best practices are being followed in template instantiation such that a template for a given type is only having to be instantiated once via explicit instantiation.\r\n\r\nMuch of our code is implemented in headers, which causes it to be recompiled everywhere that header is included. Using pre-compiled headers may help: \r\nhttps://gcc.gnu.org/onlinedocs/gcc/Precompiled-Headers.html\r\nhttp://itscompiling.eu/2017/01/12/precompiled-headers-cpp-compilation/\r\n\r\nFurthermore, code should be scrubbed from excessive and unnecessary `#include`s. Compiling with `-MD` will show what files are being included \r\n\r\nHere's a Clang tool that ensures you only include the necessary headers: https://github.com/include-what-you-use/include-what-you-use\r\n\r\nHere's a Clang tool to profile time spent in template instantiation: https://github.com/mikael-s-persson/templight\r\n\r\n\r\n\r\n\r\n\r\n","closed":false,"closedAt":null,"comments":[{"id":"MDEyOklzc3VlQ29tbWVudDQzMzI1NzI1NQ==","author":{"login":"harrism"},"authorAssociation":"MEMBER","body":"Do the clang tools work with nvcc? Much of our template time is in nvcc. You can use `nvcc --time foo.csv` to dump timing for different nvcc phases.","createdAt":"2018-10-26T01:31:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-433257255","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDQzMzI1OTAzMQ==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"I'm not sure. You can technically get Clang to compile device code, so that may be a path worth exploring using Clang + these tools.","createdAt":"2018-10-26T01:43:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-433259031","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY0MzEyMDE2Nw==","author":{"login":"hcho3"},"authorAssociation":"CONTRIBUTOR","body":"Any updates on this? I'd love to use precompiled headers with CUDA projects.","createdAt":"2020-06-12T07:34:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-643120167","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY0Mzg0NjUwMw==","author":{"login":"harrism"},"authorAssociation":"MEMBER","body":"Compile time continues to grow, but that is largely because our supported feature set and supported types continue to grow.  In 0.15 we are aiming to add at least 10 new types (4 unsigned int types, 4 timestamp types, list column type, decimal fixed-point type). Naturally this will increase compile time and binary size.\r\n\r\nMeanwhile, in 0.14 we dropped all of the legacy APIs that were previously deprecated, which reduced compile time a bit, and significantly reduced binary size.  There have been and will continue to be various efforts to reduce compile time  of  certain components. We are investigating possibly splitting libcudf into multiple libraries.\r\n\r\nWe have not discussed precompiled headers. ","createdAt":"2020-06-15T00:34:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-643846503","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps40zEFj","author":{"login":"beckernick"},"authorAssociation":"MEMBER","body":"@jrhemstad @harrism , is this still a relevant issue?","createdAt":"2021-07-23T17:50:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-885801315","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps40zo4z","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"Our compile time is worse than ever, so I guess its still relevant. We could benefit from someone putting in a concerted effort to eliminate unnecessary includes across the library. ","createdAt":"2021-07-23T22:56:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-885952051","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5Q_M3W","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"> I'm not sure. You can technically get Clang to compile device code, so that may be a path worth exploring using Clang + these tools.\r\n\r\nOut of curiosity I gave this a quick shot. (Unsurprisingly) clang does not currently support the experimental CUDA features that we have enabled (`--expt-extended-lambda --expt-relaxed-constexpr`) so the compilation terminates pretty quickly. Not sure if there are other downstream issues that we would face if we attempted this after stripping those out (not suggesting that we should, although #7795 remains open so maybe it is worth pursuing).","createdAt":"2022-12-20T02:12:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-1358745046","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5RKNcM","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"> clang does not currently support the experimental CUDA features that we have enabled (--expt-extended-lambda --expt-relaxed-constexpr)\r\n\r\nPretty sure clang supports those features natively without the need for any extra compile flags. I'm guessing the error was caused by clang not recognizing those flags. ","createdAt":"2022-12-21T16:34:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-1361630988","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5RLQ45","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"You're right, it does. I removed those and made some progress, but not nearly enough for a working build with clang yet. Here's a list of necessary changes so far:\r\n- Remove all `CUDF_CUDA_FLAGS` set in ConfigureCUDA.cmake. Most are either unsupported or ignored (including some of the warnings flags), so the blanket removal is easiest.\r\n- Remove `[[nodiscard]]` attributes, which don't appear to be supported in clang device code yet.\r\n- Set `-D__STRICT_ANSI__` as a CUDA compiler flag. Otherwise it tries to compile float128 code, which is not yet supported in clang.\r\n- Pass `-fcuda-allow-variadic-functions` to the clang compiler (or via the CMake configure CLI `-DCMAKE_CUDA_FLAGS=\"-Xclang -fcuda-allow-variadic-functions\"`\r\n\r\nAt this point I start seeing failures like this:\r\n```\r\n...type_traits:2777:5: error: no type named 'type' in 'std::invoke_result<cudf::detail::indexalator_factory::nullable_index_accessor, int>'\r\n```\r\nand \r\n```\r\nerror: type 'thrust::transform_iterator<(lambda at ...gather.cu:49:26), cudf::detail::input_indexalator>::super_t' (aka 'iterator_adaptor<transform_iterator<(lambda at ...gather.cu:49:26), cudf::detail::input_indexalator, thrust::use_default, thrust::use_default>, cudf::detail::input_indexalator, int, thrust::use_default, std::random_access_iterator_tag, int>') is not a direct or virtual base of 'thrust::transform_iterator<(lambda at ...gather.cu:49:26), cudf::detail::input_indexalator>'\r\n```\r\nI need to track this down a bit further, but it looks like some aspect of how thrust SFINAEs different code paths isn't supported in clang device code yet either.","createdAt":"2022-12-21T18:58:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-1361907257","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5RMIEl","author":{"login":"PointKernel"},"authorAssociation":"MEMBER","body":"I tried to build cuco with clang about a year ago and was blocked by its dependencies like thrust or libcudacxx that cannot be built with clang. To find how much effort is required to build device code with clang, I would suggest starting with a smaller library like cuco and see how it goes from there.\r\n\r\nRelated issues:\r\n\r\n- https://github.com/NVIDIA/cccl/issues/991\r\n- https://github.com/NVIDIA/cuCollections/issues/128","createdAt":"2022-12-21T21:46:13Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-1362133285","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5RMTJt","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"Well then... looks like we've got to work our way all the way up the stack for this. For the purpose of something like clang-tidy we might be able to get some partial results based on the discussion in https://github.com/rapidsai/raft/pull/424, but that's probably only partial support at best and I don't know if that will work with the other tools of interest like IWYU.","createdAt":"2022-12-21T22:24:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/581#issuecomment-1362178669","viewerDidAuthor":false}],"createdAt":"2018-09-09T17:57:58Z","id":"MDU6SXNzdWUzOTMyMzI3NDg=","labels":[{"id":"MDU6TGFiZWwxMTM5NzUwMDA1","name":"CMake","description":"CMake build issue","color":"d319ab"}],"milestone":{"number":26,"title":"Helps developer velocity","description":"","dueOn":null},"number":581,"projectCards":[{"project":{"name":"Other Issues"},"column":{"name":"Future release"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"Compile times are growing significantly","updatedAt":"2024-02-23T17:59:36Z","url":"https://github.com/rapidsai/cudf/issues/581"}
