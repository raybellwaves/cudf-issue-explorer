{"assignees":[],"author":{"id":"MDQ6VXNlcjExMjY5ODE=","is_bot":false,"login":"wence-","name":"Lawrence Mitchell"},"body":"During review of #13419 we noted a few places where there is a pattern like:\r\n\r\n```python\r\nsome_frame = ...\r\nindices = some_frame.some_column.argsort()\r\nnew_frame = some_frame.take(indices)\r\n```\r\n\r\nAs well as the unnecessary bounds-check (see #13456), this is a pattern that is captured by libcudf's [`sort_by_key`](https://docs.rapids.ai/api/libcudf/stable/group__column__sort.html#ga6db0403a43150b3bca0fbb9b2fbd68a3) and [`stable_sort_by_key`](https://docs.rapids.ai/api/libcudf/stable/group__column__sort.html#gaea04f441fe246b5a7e4f6420864024d4) functions (we would want to use the latter in pandas-compat mode).\r\n\r\nAt present, libcudf implements this as a `argsort` of the key columns followed by a gather. But that's an implementation detail (there may in the future be updates to that implementation). In the Python layer we should \"say what we mean\" and call into the appropriate libcudf API.\r\n\r\nA cursory search shows:\r\n\r\n```\r\n/usr/bin/rg -U -e argsort.\\*'     \r\n'.\\*take\r\n\r\ncore/_base_index.py\r\n1305:        indices = self.argsort(ascending=ascending, na_position=na_position)\r\n1306:        index_sorted = self.take(indices)\r\n\r\ncore/indexed_frame.py\r\n2464:                # double-argsort to map back from sorted to unsorted positions\r\n2465:                df = df.take(index.argsort(ascending=True).argsort())\r\n\r\ncore/column/column.py\r\n1382:        order = order.take(left_gather_map, check_bounds=False).argsort()\r\n1383:        codes = codes.take(order)\r\n\r\ncore/groupby/groupby.py\r\n686:            gather_map = ordering.take(to_take).argsort()\r\n687:            return result.take(gather_map)\r\n```\r\n\r\nOf these, the calls in `_base_index.py`, `_column.py`, and `groupby.py` can definitely be replaced by `sort_by_key`. Note also that none of these calls pass `check_bounds=False` to `take` so incur an unnecessary kernel launch to check in-boundsness for something that is guaranteed in bounds.\r\n\r\nThe `take(argsort().argsort())` pattern is not a `sort_by_key`, however, we can elide one of the argsorts by noticing that `take` is a gather operation and for a permutation, the dual to gather is scatter. So this should be implemented as `df.scatter(index.argsort())` instead...\r\n\r\nThese are just the cases where an argsort is _immediately_ followed by a take, probably more diligent searching would find more.\r\n```[tasklist]\r\n### Tasks\r\n- [ ] `RollingGroupby.__init__`\r\n- [ ] `Groupby._head_tail`\r\n- [ ] `IndexedFrame.interpolate`\r\n- [ ] `IndexedFrame.sort_index`\r\n- [ ] `IndexedFrame._reindex`\r\n- [ ] `IndexedFrame.sort_values`\r\n- [ ] `IndexedFrame._n_largest_or_smallest`\r\n- [ ] `BaseIndex.sort_values`\r\n- [ ] `MultiIndex.__repr__`\r\n```\r\n","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5h5Cha","author":{"login":"bdice"},"authorAssociation":"CONTRIBUTOR","body":"We also have a related problem in the C++ layer, where we [sort indices and then gather in places like `segmented_sort_by_key_common`](https://github.com/rapidsai/cudf/blob/84578d793e4bf5a0924766d39ff717f5d9d71820/cpp/src/sort/segmented_sort_impl.cuh#L302C24-L302C52). At the libcudf level, we have to consider nulls and nontrivial types (where a gather is needed for handling those) but the same general idea applies: sort directly wherever possible. https://github.com/rapidsai/cudf/pull/13669#discussion_r1268276705","createdAt":"2023-07-19T15:49:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/13557#issuecomment-1642342490","viewerDidAuthor":false}],"createdAt":"2023-06-13T10:57:12Z","id":"I_kwDOBWUGps5olTYK","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMzIyMjUyNjE3","name":"Performance","description":"Performance related issue","color":"C2E0C6"}],"milestone":null,"number":13557,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[ENH] Audit `argsort + gather/scatter` patterns for missing performance","updatedAt":"2023-11-23T17:53:01Z","url":"https://github.com/rapidsai/cudf/issues/13557"}
