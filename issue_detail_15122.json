{"assignees":[],"author":{"id":"MDQ6VXNlcjE5MDEwNTk=","is_bot":false,"login":"abellina","name":"Alessandro Bellina"},"body":"While benchmarking some code we found that about 5% worth of time are being lost due to this line of code:\r\nhttps://github.com/rapidsai/cudf/blob/branch-24.04/cpp/src/io/parquet/reader_impl.cpp#L248\r\n\r\nThis is on our perf cluster (A100) for NDS @3k. It explains some of a dip in perf we have seen since 23.10 but we haven't gotten around to testing. \r\n\r\nIf I stop obtaining the value from `error_code` (e.g. I don't perform the pageable memcpy essentially) we gain 20 seconds locally. I am filing this because it may be a good idea to remove this or look into how to improve it (would a pinned copy help)?","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps502qRo","author":{"login":"abellina"},"authorAssociation":"CONTRIBUTOR","body":"@nvdbaranec @vuule fyi","createdAt":"2024-02-22T23:05:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15122#issuecomment-1960485992","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps502wtN","author":{"login":"vuule"},"authorAssociation":"CONTRIBUTOR","body":"That's wild. Have you maybe looked at a profile to see how we spend the additional time?","createdAt":"2024-02-22T23:33:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15122#issuecomment-1960512333","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5023QT","author":{"login":"abellina"},"authorAssociation":"CONTRIBUTOR","body":"it's over many queries, I think it is due to the pageable copy (synchronization due to staging copies). I wonder if a quick prototype would be to swap the pageable copy by a pinned one and see if we recover the amount of time lost.","createdAt":"2024-02-23T00:05:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15122#issuecomment-1960539155","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5025AW","author":{"login":"vuule"},"authorAssociation":"CONTRIBUTOR","body":"I can prototype something tomorrow. My concern is that we'll break even without the pinned pool due to the extra pinned allocation.","createdAt":"2024-02-23T00:10:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15122#issuecomment-1960546326","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5025MI","author":{"login":"abellina"},"authorAssociation":"CONTRIBUTOR","body":"this would imply having @nvdbaranec's pinned pool https://github.com/rapidsai/cudf/pull/15079, so the allocation should be virtually free :)","createdAt":"2024-02-23T00:11:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15122#issuecomment-1960547080","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5025lZ","author":{"login":"vuule"},"authorAssociation":"CONTRIBUTOR","body":"yeah but only spark will have the pool for now ;)","createdAt":"2024-02-23T00:13:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15122#issuecomment-1960548697","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps506eSX","author":{"login":"GregoryKimball"},"authorAssociation":"CONTRIBUTOR","body":"Thank you @abellina for posting this. Please also consult #14167 and #14415 for a similar error code check and performance fix. Would you please investigate a single-GPU single-node reproducer for this performance issue? Do you think a single-GPU reproducer is possible?","createdAt":"2024-02-23T14:59:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/15122#issuecomment-1961485463","viewerDidAuthor":false}],"createdAt":"2024-02-22T23:05:41Z","id":"I_kwDOBWUGps6AJ9TH","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":15122,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG] parquet reader::impl::decode_page_data error_code checking slowness","updatedAt":"2024-02-23T14:59:52Z","url":"https://github.com/rapidsai/cudf/issues/15122"}
