{"assignees":[{"id":"MDQ6VXNlcjEwNjQ3MDgy","login":"mroeschke","name":"Matthew Roeschke"},{"id":"MDQ6VXNlcjQxMzQyMzA1","login":"Matt711","name":"Matthew Murray"}],"author":{"id":"MDQ6VXNlcjM5NDM3NjE=","is_bot":false,"login":"bdice","name":"Bradley Dice"},"body":"**Is your feature request related to a problem? Please describe.**\r\nThe default execution model for `cudf.pandas` is to try to execute an operation on the GPU, then fall back to the CPU if it fails for any reason. This approach is desirable for end-users to maximize the number of cases where `cudf.pandas` \"just works\", but it makes it difficult to analyze when failures are occurring and why. The former can be addressed by running under the profiler, but that is more cumbersome than we would like in many cases where we would rather get a quick signal in the form of failure (e.g. when running a workflow or a test suite to analyze unsupported cases). Furthermore, there is no easy way to determine whether cudf and pandas return the same results for a given operation, which is a different failure mode that is currently not possible to capture.\r\n\r\n**Describe the solution you'd like**\r\nWe should generalize `_fast_slow_function_call` to support a wider range of fallback options. These options could be configurable by an environment variable, or by some global configuration option (the former is probably fine to start with). The different behaviors we would want to support are:\r\n- Error on fallback. We could then run the pandas test suite with this turned on and get a sense of how many tests cudf passes on its own.\r\n- Error on specific types of fallback. This would allow us to analyze the types of fallback that are occurring. Some of the most obvious error modes I can foresee (there are certainly others) are:\r\n    - Out of memory errors, for the sake of planning No OOM related work\r\n    - AttributeErrors for missing functionality\r\n    - TypeErrors for differing function signatures\r\n- Error when cudf and pandas produce different outputs. This would be an extra branch within the fast path where the slow path is run even if the fast path succeeds, and then the fast and slow paths are compared for equivalence.\r\n\r\nWe may want to support warning instead of raising errors in some cases, but I don't think that's critical to start.\r\n\r\n**Describe alternatives you've considered**\r\nThis could be configured by the cudf.pandas profiler, or a similar context manager?\r\n\r\n**Additional context**\r\nFeedback from @ianozsvald and @lmeyerov would be welcome!","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5zHeu9","author":{"login":"lmeyerov"},"authorAssociation":"NONE","body":"A python `Warning` object so we can do managed handling would make sense \r\n\r\nNote we are not `cudf.pandas` users but `cudf`, so our interest would be seeing the same thing there","createdAt":"2024-02-07T05:55:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-1931340733","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5zMQnn","author":{"login":"bdice"},"authorAssociation":"CONTRIBUTOR","body":"@lmeyerov `cudf` doesn't fall back to CPU so you'd never see this with normal `cudf` usage. Only `cudf.pandas` has CPU fallback behavior. Can you clarify what you mean?","createdAt":"2024-02-07T18:02:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-1932593639","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5zNjQ9","author":{"login":"lmeyerov"},"authorAssociation":"NONE","body":"Re:cudf, Some reason I thought a few cudf methods will fall back to CPU, like in parsing or others, rather than throwing NotImpl or a warning\r\n\r\nSeperately / more broadly, there are some perf gotchas in cudf like where it makes copies or sorts that good code would avoid. A perf tips flag/mode that warns in these cases would be helpful for us, not just for the CPU fallback case. But that is a bigger story.\r\n","createdAt":"2024-02-07T21:16:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-1932932157","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5zNyZD","author":{"login":"bdice"},"authorAssociation":"CONTRIBUTOR","body":"Good feedback! There are a few cases in I/O where cudf does not offer a GPU-accelerated reader/writer for every format. That's the only exception I can think of right now where cudf executes CPU-only code (it copies to device and returns a GPU dataframe at the end). Those are documented in the notes on this page: https://docs.rapids.ai/api/cudf/stable/user_guide/io/io/\r\n\r\nI can think of a few algorithms where cudf has cut down on extraneous copies/sorting over the last few releases (like `drop_duplicates`). If any specific cases come to mind, please file issues for those! We're aiming to reduce intermediate memory usage in cudf and these would likely align with that goal (in addition to improving performance).","createdAt":"2024-02-07T21:48:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-1932994115","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5zOBsx","author":{"login":"lmeyerov"},"authorAssociation":"NONE","body":"Yes, my meta is perf warnings mode, like when defaults are slow for conformance reasons and a special calling pattern would make faster, would be very helpful :)","createdAt":"2024-02-07T22:42:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-1933056817","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5-r66X","author":{"login":"Matt711"},"authorAssociation":"CONTRIBUTOR","body":"> * Error when cudf and pandas produce different outputs. This would be an extra branch within the fast path where the slow path is run even if the fast path succeeds, and then the fast and slow paths are compared for equivalence.\r\n\r\nIf it's okay with you @mroeschke, can I still work on this component since it covers the [issue](https://github.com/rapidsai/cudf/issues/15817) I opened?","createdAt":"2024-05-22T18:04:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-2125442711","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5-r8EH","author":{"login":"mroeschke"},"authorAssociation":"CONTRIBUTOR","body":"> If it's okay with you @mroeschke, can I still work on this component since it covers the https://github.com/rapidsai/cudf/issues/15817 I opened?\r\n\r\nYes go for it @Matt711! ","createdAt":"2024-05-22T18:07:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-2125447431","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5_boud","author":{"login":"Matt711"},"authorAssociation":"CONTRIBUTOR","body":"We could have two debugging mode options (note: we can use different names):\r\n1. `mode.pandas_debugging` \r\n2. `mode.fallback_debugging` \r\n\r\n(1.) is for when fallback does not occur. It checks that the results from cudf and pandas agree and returns a warning if they do not. I'm working on that option in this PR #15837 .\r\n\r\n(2.) is for when fallback does occur. It could return errors on the specific types of fallback mentioned:\r\n> - Out of memory errors, for the sake of planning No OOM related work\r\n> - AttributeErrors for missing functionality\r\n> - TypeErrors for differing function signatures\r\n\r\nWhat do we think about these two options?\r\n\r\ncc. @bdice @vyasr @wence- ","createdAt":"2024-05-29T17:45:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-2137951133","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5_dv7I","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"Making these modes independently configurable is definitely what we want, yes. [As I commented on this in #15837, though](https://github.com/rapidsai/cudf/pull/15837#discussion_r1619623069), I don't think options are the right way to expose this. options are user-facing, whereas what we're trying to accomplish here is something for developers. Some environment variables documented in the developer guide are probably closer to what I would envision, especially for the first one (pandas_debugging). I don't see a reason for a user to ever need that one. I could envision exposing some internal APIs to control the second case (fallback_debugging) because in that scenario it could be useful to have the profiler hook into these so that users could collect information on why fallback occurred.","createdAt":"2024-05-30T01:25:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-2138504904","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5_h38y","author":{"login":"Matt711"},"authorAssociation":"CONTRIBUTOR","body":"Using an environment variable instead of an option is fine with me. I am curious if you have a more specific place in mind in the [Developer Guide](https://docs.rapids.ai/api/cudf/stable/developer_guide/) for documenting the environment variable? ","createdAt":"2024-05-30T13:41:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-2139586354","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5_iVPz","author":{"login":"wence-"},"authorAssociation":"CONTRIBUTOR","body":"Maybe we can add a new section on the fast-slow-proxy wrapping scheme. It can be mostly stubbed out and we can add info.","createdAt":"2024-05-30T14:30:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-2139706355","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5_iWO3","author":{"login":"Matt711"},"authorAssociation":"CONTRIBUTOR","body":"> Maybe we can add a new section on the fast-slow-proxy wrapping scheme. It can be mostly stubbed out and we can add info.\r\n\r\nYes, and I could add that in a new cudf.pandas section in the Developer Guide?","createdAt":"2024-05-30T14:31:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/14975#issuecomment-2139710391","viewerDidAuthor":false}],"createdAt":"2024-02-06T17:03:52Z","id":"I_kwDOBWUGps5-cETC","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":14975,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Offer more control over CPU fallback in cudf.pandas","updatedAt":"2024-05-30T14:31:42Z","url":"https://github.com/rapidsai/cudf/issues/14975"}
