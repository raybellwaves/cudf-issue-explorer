{"assignees":[],"author":{"id":"MDQ6VXNlcjM4NDc1MTk0","is_bot":false,"login":"alextxu","name":"Alex Xu"},"body":"**Describe the bug**\r\nGetting an `UnboundLocalError: local variable 'index_class_type' referenced before assignment` when calling the cudf.DataFrame.all function. The data frame was created from comparing two data frames with the same columns and index attributes, one of which is generated from a call to cudf.DataFrame.pivot.\r\n\r\n**Steps/Code to reproduce bug**\r\n```Python\r\nimport cupy\r\nimport cudf\r\n\r\nx = cupy.array([[1,2,3],[4,2,5]])\r\ndf = cudf.DataFrame(x)\r\npivot_table = df.pivot(index=[0], columns=[1], values=[2])\r\ndf2 = cudf.DataFrame(cupy.broadcast_to(pivot_table.iloc[:,0].values[:,None], pivot_table.shape), index=pivot_table.index, columns=pivot_table.columns)\r\n\r\nprint((df2 == pivot_table).all())\r\n```\r\n\r\n**Expected behavior**\r\nExpected output:\r\n```\r\n2    True\r\ndtype: bool\r\n```\r\n\r\n**Environment overview (please complete the following information)**\r\n - Environment location: Docker\r\n - Method of cuDF install: Docker\r\n   - `docker run -it --rm --gpus all --ipc=host --network=host -v .`\r\n\r\n**Environment details**\r\nVersion: 22.4.0a0+306.g0cb75a4913\r\n\r\n**Additional context**\r\nThis snippet works as expected in cuDF 22.2.0 but does not work on cuDF 22.4.0.\r\n","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5Ff30-","author":{"login":"bdice"},"authorAssociation":"CONTRIBUTOR","body":"Thanks for the issue report @alextxu! I'm going to document what I've investigated thus far. I think there are two or three separate subproblems for us to investigate.\r\n\r\nPandas gives:\r\n```python\r\n>>> pivot_table.index\r\nInt64Index([1, 4], dtype='int64', name=0)\r\n>>> pivot_table.columns\r\nMultiIndex([(2, 2)],\r\n           names=[None, 1])\r\n>>> (df2 == pivot_table).all()\r\n   1\r\n2  2    True\r\ndtype: bool\r\n>>> (df2 == pivot_table).all().index\r\nMultiIndex([(2, 2)],\r\n           names=[None, 1])\r\n```\r\n\r\nI filed a PR https://github.com/rapidsai/cudf/pull/11150 that fixed the `UnboundLocalError` but there are some discrepancies with Pandas in the index/columns of `pivot_table` and the index of the final result. From cuDF e16ab0174b22cf08ee919155dfba184f1f7bbff7:\r\n```python\r\n>>> pivot_table.index\r\nMultiIndex([(1,),\r\n            (4,)],\r\n           names=[0])\r\n>>> pivot_table.columns\r\nMultiIndex([(2, 2)],\r\n           names=[nan, 1.0])\r\n>>> (df2 == pivot_table).all()\r\n[2, 2]    True\r\ndtype: bool\r\n>>> (df2 == pivot_table).all().index\r\nGenericIndex([[2, 2]], dtype='list')\r\n```","createdAt":"2022-06-24T22:11:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11148#issuecomment-1165983038","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5HU0aD","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-30d` due to no recent activity in the past 30 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed. This issue will be labeled `inactive-90d` if there is no activity in the next 60 days.","createdAt":"2022-07-27T12:03:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11148#issuecomment-1196639875","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5M6okF","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-90d` due to no recent activity in the past 90 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed.","createdAt":"2022-10-25T12:05:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11148#issuecomment-1290438917","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5NVI79","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"I'm going to leave this issue open to track the bugs that @bdice identified while fixing the proximate cause of the observed bug.","createdAt":"2022-10-31T16:56:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11148#issuecomment-1297387261","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5-OqTe","author":{"login":"vyasr"},"authorAssociation":"CONTRIBUTOR","body":"There are a couple of outstanding issues here. The first is that our pivot API does not properly handle when the index or columns arguments are lists instead of single values. IOW, this works\r\n```\r\npivot_table = df.pivot(index=0, columns=1, values=[2])\r\n```\r\nbut making either the index or columns arguments above into a list results in \r\n```\r\nValueError: Index data must be 1-dimensional and list-like\r\n```\r\nFor `index` the failure is [here](https://github.com/rapidsai/cudf/blob/fcbc1bc8a5d81797c4974ff7559eac44f3854697/python/cudf/cudf/core/reshape.py#L1053), whereas for `columns` the failure is [on the subsequent line](https://github.com/rapidsai/cudf/blob/fcbc1bc8a5d81797c4974ff7559eac44f3854697/python/cudf/cudf/core/reshape.py#L1054). \r\n\r\nThe second issue is that we do not have a way to handle list dtype columns when we attempt to make an index out of them, so if we bypass the above issue by passing index and columns as scalars, we end up failing on the final line with \r\n```\r\nNotImplementedError: Unsupported column type passed to create an Index: <class 'cudf.core.column.lists.ListColumn'>\r\n```","createdAt":"2024-05-17T14:47:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/11148#issuecomment-2117772510","viewerDidAuthor":false}],"createdAt":"2022-06-24T20:37:57Z","id":"I_kwDOBWUGps5Mit68","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"MDU6TGFiZWwxMTM5NzQxMjEz","name":"cuDF (Python)","description":"Affects Python cuDF API.","color":"1d76db"}],"milestone":null,"number":11148,"projectCards":[{"project":{"name":"Bug Squashing"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG] cudf.DataFrame.all error on pivot-generated data frame","updatedAt":"2024-05-17T14:47:55Z","url":"https://github.com/rapidsai/cudf/issues/11148"}
