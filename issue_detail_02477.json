{"assignees":[],"author":{"id":"MDQ6VXNlcjEzNjA3NjY=","is_bot":false,"login":"jlowe","name":"Jason Lowe"},"body":"**Is your feature request related to a problem? Please describe.**\r\nApache Spark internally tracks timestamps relative to the epoch in the JVM's default timezone.  cudf uses timestamps relative to the epoch in the UTC timezone (at least in the ORC loader).  When Spark tries to interpret timestamp data created/loaded by cudf the values are incorrect (from Spark's viewpoint) unless the JVM's default timezone is UTC.\r\n\r\n**Describe the solution you'd like**\r\nA timezone conversion utility function for timestamps in libcudf would help, as the timestamp column could be converted from UTC to the JVM's timezone.  The utility function would take an input timestamp column, a source timezone and a destination timezone, and would return a new timestamp column with the timestamp values adjusted by the time delta difference between the two timezones at the source timestamp's time.  Note that due to effects like daylight savings, the delta between timezones is not necessarily constant and therefore this utility method can't be obviated by a simple scalar addition on the timestamp column data.\r\n\r\n**Describe alternatives you've considered**\r\nAdding an optional, target timezone parameter to the various cudf data loaders (like the ORC reader) could work as well and potentially be more efficient if it avoids the separate CUDA kernel to do the conversion from UTC.  However the utility method approach seems like a more flexible approach to cover cases where the timestamp data source didn't originate from a cudf data loader.","closed":false,"closedAt":null,"comments":[{"id":"MDEyOklzc3VlQ29tbWVudDUxODkyNTU5NQ==","author":{"login":"OlivierNV"},"authorAssociation":"CONTRIBUTOR","body":"Is this specific to ORC ? ORC has the concept of a writer timezone, and we actually convert from the writer timezone to UTC when loading, so if the intent is to keep the native timezone of the ORC file, it could be as simple as a flag to bypass the existing timezone conversion.\r\nIf it's a generic target timezone conversion, it should be relatively easy to do it in the ORC loader (converting to a particular timezone isn't much different than the existing conversion to UTC). For other loaders that are natively UTC, it would be preferable as a standalone utility method.","createdAt":"2019-08-07T03:31:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-518925595","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDUxOTEwMTU3Mw==","author":{"login":"jlowe"},"authorAssociation":"MEMBER","body":"It's not specific to ORC.  The intent is not to preserve the timezone of the file but rather to target a timezone that's specified by the caller.  ORC is already doing timezone conversions, and that's why I mention it here.  It would be slightly more efficient to have ORC directly convert to a specified timezone rather than convert to UTC and then the caller converts to another timezone.\r\n\r\nI agree that a standalone utility method would be best if we're only going to have one way to rebase timestamps.  That can apply to the CSV and Parquet loaders which don't do any timezone conversions today.\r\n\r\nThe utility would also provide a way to convert Spark timestamps back to UTC.  This would probably be needed when cudf supports writing CSV, Parquet, and ORC, as I would expect those writers to assume all timestamps are UTC.  Spark would need to convert timestamps relative to the JVM timezone to UTC for cudf writing unless the writers supported a parameter specifying the timestamp timezone reference.\r\n","createdAt":"2019-08-07T13:40:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-519101573","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDUxOTM1MzA0Mg==","author":{"login":"OlivierNV"},"authorAssociation":"CONTRIBUTOR","body":"Timezone conversions are super-messy, so I'd rather limit the impact of timezones (it also tends to be platform-specific since we need to parse timezone files from the OS to build conversion tables from/to UTC).\r\nCompared to the column loader, a standalone timezone conversion should be very fast since it's fully data-parallel (internally, timezoneA->timezoneB would most likely be implemented as\r\n tsB = fromUTC(toUTC(tsA, A), B).\r\nIf the goal is an arbitrary target timezone, I think an in-place standalone conversion would be the way to go.","createdAt":"2019-08-08T03:57:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-519353042","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDU2MTg2NTQ0Ng==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"Since we are using libcu++ for our timestamp types, we should be using the C++20 timezone APIs that libcu++ will provide. CC @trxcllnt. ","createdAt":"2019-12-04T22:19:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-561865446","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDU2MTkxODc0NQ==","author":{"login":"trxcllnt"},"authorAssociation":"CONTRIBUTOR","body":"@brycelelbach does libcu++ have plans to load the system timezone database? I recall @ogiroux saying that might not be supported yet.","createdAt":"2019-12-05T01:04:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-561918745","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDU2MTkxOTA4OA==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"@brycelelbach promised me they would add it for us :) ","createdAt":"2019-12-05T01:05:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-561919088","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcyNjM4NTk0NQ==","author":{"login":"sameerz"},"authorAssociation":"CONTRIBUTOR","body":"Any update on whether libcu++ will load the timezone database?  ","createdAt":"2020-11-12T22:41:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-726385945","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcyNjM5Nzg4NA==","author":{"login":"brycelelbach"},"authorAssociation":"CONTRIBUTOR","body":"Please file an RFE on github.com/NVIDIA/libcudacxx. It's not on our immediate roadmap, and slightly tricky, but we'll get to it eventually, depending on how urgently you need it.","createdAt":"2020-11-12T23:11:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-726397884","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcyNjk5OTk1MQ==","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"https://github.com/NVIDIA/cccl/issues/954","createdAt":"2020-11-13T19:53:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/2477#issuecomment-726999951","viewerDidAuthor":false}],"createdAt":"2019-08-06T20:39:48Z","id":"MDU6SXNzdWU0Nzc1ODM1MjY=","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMTM5NzQwNjY2","name":"libcudf","description":"Affects libcudf (C++/CUDA) code.","color":"c5def5"},{"id":"MDU6TGFiZWwxMTg1MjQ0MTQy","name":"cuIO","description":"cuIO issue","color":"fef2c0"},{"id":"MDU6TGFiZWwxNDA1MTQ2OTc1","name":"Spark","description":"Functionality that helps Spark RAPIDS","color":"7400ff"}],"milestone":{"number":17,"title":"Support datetime localization in cuDF","description":"","dueOn":null},"number":2477,"projectCards":[{"project":{"name":"Feature Planning"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Timezone conversions for timestamps","updatedAt":"2022-09-21T16:17:00Z","url":"https://github.com/rapidsai/cudf/issues/2477"}
