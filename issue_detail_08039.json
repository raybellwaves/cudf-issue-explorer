{"assignees":[{"id":"MDQ6VXNlcjEyNzE2OTc5","login":"PointKernel","name":"Yunsong Wang"}],"author":{"id":"MDQ6VXNlcjE2OTI5MTQ=","is_bot":false,"login":"randerzander","name":"Randy Gelhausen"},"body":"I'd like to be able to use lists as keys in a groupby:\r\n```\r\nimport cudf\r\n\r\ndf = cudf.DataFrame({\r\n    'id': [0, 1],\r\n    'id_lst': [[0, 0], [1, 1]],\r\n    'val': [0, 1]\r\n})\r\n\r\ndf.groupby(['id', 'id_lst']).val.sum()\r\n```\r\nResult:\r\n```\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n~/conda/envs/rapids/lib/python3.8/site-packages/pandas/core/arrays/categorical.py in __init__(self, values, categories, ordered, dtype, fastpath)\r\n    339             try:\r\n--> 340                 codes, categories = factorize(values, sort=True)\r\n    341             except TypeError as err:\r\n\r\n~/conda/envs/rapids/lib/python3.8/site-packages/pandas/core/algorithms.py in factorize(values, sort, na_sentinel, size_hint)\r\n    721 \r\n--> 722         codes, uniques = factorize_array(\r\n    723             values, na_sentinel=na_sentinel, size_hint=size_hint, na_value=na_value\r\n\r\n~/conda/envs/rapids/lib/python3.8/site-packages/pandas/core/algorithms.py in factorize_array(values, na_sentinel, size_hint, na_value, mask)\r\n    527     table = hash_klass(size_hint or len(values))\r\n--> 528     uniques, codes = table.factorize(\r\n    529         values, na_sentinel=na_sentinel, na_value=na_value, mask=mask\r\n\r\npandas/_libs/hashtable_class_helper.pxi in pandas._libs.hashtable.PyObjectHashTable.factorize()\r\n\r\npandas/_libs/hashtable_class_helper.pxi in pandas._libs.hashtable.PyObjectHashTable._unique()\r\n\r\nTypeError: unhashable type: 'numpy.ndarray'\r\n```\r\n\r\nOne workaround is once [string list concatenation](https://github.com/rapidsai/cudf/pull/7929) merges, converting `id_lst` to a tokenized string and using the string representation as the grouping key.","closed":false,"closedAt":null,"comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg0NjQ1MTY0NA==","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-30d` due to no recent activity in the past 30 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed. This issue will be labeled `inactive-90d` if there is no activity in the next 60 days.","createdAt":"2021-05-22T19:13:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-846451644","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5EanL-","author":{"login":"bdice"},"authorAssociation":"CONTRIBUTOR","body":"This is partially resolved by #10770. The remaining work to close this issue is to implement lexicographical comparators `<` to enable sort-based groupby.","createdAt":"2022-06-06T19:33:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1147826942","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5Lc1mc","author":{"login":"GregoryKimball"},"authorAssociation":"CONTRIBUTOR","body":"This looks closer after merging #11129 but not quite working yet. \r\n\r\nsorting on list columns works:\r\n```\r\n>>> import cudf\r\n>>> df = cudf.DataFrame({'a':[[1,2],[1,1]], 'b':[1,2]})\r\n>>> df.sort_values('a')\r\n        a  b\r\n1  [1, 1]  2\r\n0  [1, 2]  1\r\n```\r\n\r\nbut groupby does not due to a cuDF error. Perhaps list types aren't supported in the index as groupby would require\r\n```\r\n>>> df.groupby('a').mean()\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/site-packages/cudf/core/mixins/mixin_factory.py\", line 11, in wrapper\r\n    return method(self, *args1, *args2, **kwargs1, **kwargs2)\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/site-packages/cudf/core/groupby/groupby.py\", line 530, in _reduce\r\n    return self.agg(op)\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/contextlib.py\", line 75, in inner\r\n    return func(*args, **kwds)\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/site-packages/cudf/core/groupby/groupby.py\", line 458, in agg\r\n    ) = self._groupby.aggregate(columns, normalized_aggs)\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/functools.py\", line 967, in __get__\r\n    val = self.func(instance)\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/site-packages/cudf/core/groupby/groupby.py\", line 378, in _groupby\r\n    [*self.grouping.keys._columns], dropna=self._dropna\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/site-packages/cudf/core/groupby/groupby.py\", line 1745, in keys\r\n    return cudf.core.index.as_index(\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/contextlib.py\", line 75, in inner\r\n    return func(*args, **kwds)\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/site-packages/cudf/core/index.py\", line 2848, in as_index\r\n    return _index_from_data({kwargs.get(\"name\", None): arbitrary})\r\n  File \"/opt/conda/envs/rapids/lib/python3.8/site-packages/cudf/core/index.py\", line 116, in _index_from_data\r\n    return index_class_type._from_data(data, name)\r\nUnboundLocalError: local variable 'index_class_type' referenced before assignment\r\n```","createdAt":"2022-10-03T18:20:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1265850780","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5Lc2Of","author":{"login":"PointKernel"},"authorAssociation":"MEMBER","body":"> This looks closer after merging #11129 but not quite working yet.\r\n\r\nThe issue would be resolved by #11792. ","createdAt":"2022-10-03T18:22:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1265853343","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5Lc9vT","author":{"login":"shwina"},"authorAssociation":"CONTRIBUTOR","body":"> Perhaps list types aren't supported in the index as groupby would require\r\n\r\nCorrect -- there's no `ListIndex` type in cuDF (or Pandas for that matter). There are two ways we could resolve this:\r\n\r\n1. Add a `ListIndex` type\r\n2. Support grouping on a list column only when `as_index=False`. At the same time, we could improve the error message when `as_index=True`.\r\n\r\n\r\nFor now I think (2) would be the simpler/faster option.","createdAt":"2022-10-03T18:47:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1265884115","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5L74k2","author":{"login":"GregoryKimball"},"authorAssociation":"CONTRIBUTOR","body":"Note: Implementing the `ListIndex` type would also solve #6932","createdAt":"2022-10-11T02:01:43Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1273989430","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5L--JG","author":{"login":"shwina"},"authorAssociation":"CONTRIBUTOR","body":"Understood. I'd be hesitant to expand our API surface area by introducing a new `ListIndex` type until we have compelling use cases. This is especially true around indexes, as we are concurrently pushing for Pandas to rely _less_ on indexes (https://github.com/pandas-dev/pandas/issues/48880).","createdAt":"2022-10-11T14:35:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1274798662","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5NZ2fy","author":{"login":"shwina"},"authorAssociation":"CONTRIBUTOR","body":"@randerzander, is this request still a high priority for you? @PointKernel and I have been experimenting with [exposing list-groupby in Python](https://github.com/rapidsai/cudf/pull/11792) and have run into a few different issues.\r\n\r\nNotably, even Pandas does not support the example snippet first posted, so we have nothing to test against:\r\n\r\n```python\r\nimport pandas as pd\r\n\r\ndf = pd.DataFrame({\r\n    'id': [0, 1],\r\n    'id_lst': [[0, 0], [1, 1]],\r\n    'val': [0, 1]\r\n})\r\n\r\ndf.groupby(['id', 'id_lst']).val.sum()\r\n# TypeError: unhashable type: 'list'\r\n```\r\n\r\nSupporting grouping by lists in Python will need us to define and document semantics different from Pandas, and involves some non-trivial [refactoring](https://github.com/rapidsai/cudf/issues/12037) of our code. I'm trying to understand if there's a pressing need to do that.","createdAt":"2022-11-01T14:51:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1298622450","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5NatoJ","author":{"login":"randerzander"},"authorAssociation":"CONTRIBUTOR","body":">@randerzander, is this request still a high priority for you? \r\n\r\nIt's not high priority, no","createdAt":"2022-11-01T17:10:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1298848265","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5NbjwW","author":{"login":"PointKernel"},"authorAssociation":"MEMBER","body":"#11792 partially solves the issue and now lists can be used as groupby keys in libcudf.\r\n\r\nFurther work to close this issue will be tracked via #12037 ","createdAt":"2022-11-01T20:01:17Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8039#issuecomment-1299069974","viewerDidAuthor":false}],"createdAt":"2021-04-22T18:26:08Z","id":"MDU6SXNzdWU4NjUyOTQ4Mjk=","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMDEzOTg3MzUy","name":"0 - Backlog","description":"In queue waiting for assignment","color":"d4c5f9"},{"id":"MDU6TGFiZWwxMTM5NzQwNjY2","name":"libcudf","description":"Affects libcudf (C++/CUDA) code.","color":"c5def5"},{"id":"MDU6TGFiZWwxMTM5NzQxMjEz","name":"cuDF (Python)","description":"Affects Python cuDF API.","color":"1d76db"}],"milestone":{"number":2,"title":"List and Struct data types and operations","description":"","dueOn":null},"number":8039,"projectCards":[{"project":{"name":"Feature Planning"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Support lists as groupby keys","updatedAt":"2022-11-01T20:39:28Z","url":"https://github.com/rapidsai/cudf/issues/8039"}
