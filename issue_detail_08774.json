{"assignees":[{"id":"MDQ6VXNlcjUzNzk2MDk5","login":"brandon-b-miller","name":""}],"author":{"id":"MDQ6VXNlcjUzNzk2MDk5","is_bot":false,"login":"brandon-b-miller","name":""},"body":"**Is your feature request related to a problem? Please describe.**\r\nWith the merge of https://github.com/rapidsai/cudf/pull/8213 we have initial support for user defined functions that involve nulls. However the behavior in the following edge case does not match pandas if the input column contains nulls:\r\n\r\n```python\r\ndef f(x):\r\n    if x > 2:\r\n        return 3\r\n    else:\r\n        return 4\r\n```\r\nIn cases where `x is cudf.NA`, the first condition will eventually resolve to `if(cudf.NA)`. In the cuDF view, `NA` is treated as falsy for lack of a better solution in the initial implementation, and thus the code will take the first branch and return 3. However in pandas, it will *raise* and go down neither branch, complaining that `The boolean value of NA is ambiguous`. This is probably the correct behavior. \r\n\r\n**Describe the solution you'd like**\r\nMake it so that numba returns a non zero exit code from kernels if this situation occurs, and then propagate that error to the user as a python error.\r\n\r\n**Describe alternatives you've considered**\r\nMaking nulls falsy leads to different results than pandas.\r\n\r\n**Additional context**\r\ncc @gmarkall ","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps40nvSL","author":{"login":"jrhemstad"},"authorAssociation":"CONTRIBUTOR","body":"How would you communicate this situation from inside the kernel to Python in order to throw? ","createdAt":"2021-07-19T20:18:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8774#issuecomment-882832523","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps40p4Qi","author":{"login":"brandon-b-miller"},"authorAssociation":"CONTRIBUTOR","body":"> How would you communicate this situation from inside the kernel to Python in order to throw?\r\n\r\nNumba writes the PTX functions such that the return value of the actual logical operation is returned through the functions first parameter. This leaves the actual return value of the function available to signal an exception. What we'd do is make it so that when this situation is detected, the thread in question returns a nonzero exit code, and then IIUC numba already has most of the machinery needed to scan the results, look up any nonzero codes and if necessary propagate an exception to the user. \r\n\r\nThis comes with a perf penalty of course which definitely needs really good benchmarking, but I speculate it may not make a noticeable difference after everything is said and done in python. \r\n\r\ncc @gmarkall who can hopefully correct anything I just said. ","createdAt":"2021-07-20T13:29:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8774#issuecomment-883393570","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps40qCeG","author":{"login":"gmarkall"},"authorAssociation":"CONTRIBUTOR","body":"What @brandon-b-miller said is correct, but there are some changes that would be needed in Numba to properly support this, because:\r\n\r\n- Numba only checks for exceptions and reports them back in the kernel when `debug=True` is passed to the `@cuda.jit` decorator\r\n- Passing `debug=True` requires optimization to be turned off, because NVVM technically doesn't support optimization and emitting debug info (see e.g. numba/numba#7214) - it works most of the time, but sometimes NVVM segfaults, which is not very desirable.\r\n\r\nIdeally we need a new kwarg for Numba's `@cuda.jit` decorator (something like `check_exceptions=True`) that we can use to get Numba to generate the exception-checking code, but without enabling all the other debuginfo generation.","createdAt":"2021-07-20T14:22:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8774#issuecomment-883435398","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps483ord","author":{"login":"github-actions"},"authorAssociation":"NONE","body":"This issue has been labeled `inactive-90d` due to no recent activity in the past 90 days. Please close this issue if no further response or action is needed. Otherwise, please respond with a comment indicating any updates or changes to the original issue and/or confirm this issue still needs to be addressed.","createdAt":"2022-01-25T14:07:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/8774#issuecomment-1021217501","viewerDidAuthor":false}],"createdAt":"2021-07-19T19:04:59Z","id":"MDU6SXNzdWU5NDc5NDE1MzI=","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NjE=","name":"feature request","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxMDE2MzIwNzI3","name":"numba","description":"Numba issue","color":"9c2cdd"},{"id":"MDU6TGFiZWwxMTM5NzQxMjEz","name":"cuDF (Python)","description":"Affects Python cuDF API.","color":"1d76db"}],"milestone":{"number":10,"title":"UDF Enhancements","description":"","dueOn":null},"number":8774,"projectCards":[{"project":{"name":"Feature Planning"},"column":{"name":"Needs prioritizing"}}],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[FEA] Properly raise when attempting to cast `NA` to bool inside UDFs","updatedAt":"2023-08-10T17:05:25Z","url":"https://github.com/rapidsai/cudf/issues/8774"}
