{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNDYxMDEz","is_bot":false,"login":"rjzamora","name":"Richard (Rick) Zamora"},"body":"**Describe the bug**\r\nThere seems to be a subtle difference between cudf and pandas for `groupby(...).apply(...)`\r\n\r\n**Steps/Code to reproduce bug**\r\n```python\r\nimport cudf\r\n\r\ndf = cudf.DataFrame({\"a\": [\"cat\", \"dog\", \"cat\"], \"b\": [0, 1, 0]})\r\ndf.groupby([\"a\", \"b\"]).apply(lambda x: x)\r\n```\r\n```\r\n     a  b\r\n0  cat  0\r\n2  cat  0\r\n1  dog  1\r\n```\r\n**Pandas Result**:\r\n```\r\n           a  b\r\na   b          \r\ncat 0 0  cat  0\r\n      2  cat  0\r\ndog 1 1  dog  1\r\n```\r\n\r\n**Expected behavior**\r\nI would expect the behavior of cudf and pandas to be consistent.\r\n\r\n**Additional context**\r\nI found this issue while debugging TPC-h query 16 and 21 with dask-cudf + dask-expr.","closed":false,"closedAt":null,"comments":[{"id":"IC_kwDOBWUGps5zgZfu","author":{"login":"imusa007"},"authorAssociation":"NONE","body":"Looks like this bug is intentional to avoid redundancy. groupby.apply documentation has a similar example of this behavior. \r\n\r\nhttps://docs.rapids.ai/api/cudf/stable/user_guide/api_docs/api/cudf.core.groupby.groupby.groupby.apply/#cudf.core.groupby.groupby.GroupBy.apply \r\n\r\nSo I am not sure if it's a bug or a design choice for better performance or any other reason??\r\n","createdAt":"2024-02-11T21:18:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14977#issuecomment-1937872878","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5zj52h","author":{"login":"rjzamora"},"authorAssociation":"MEMBER","body":"Thanks for linking that @imusa007! I did see a few notes in the code about this after raising the issue.\r\n\r\nIt seems okay to close this issue and mark it as \"wontfix\" for now. Especially if the \"fix\" requires significant time from anyone (I haven't really looked into it yet). With that said, this divergence will require us to implement/maintain a separate code path in dask-cudf for `nunique`. So, we will need to add code either way.","createdAt":"2024-02-12T14:33:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14977#issuecomment-1938791841","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5zlze3","author":{"login":"shwina"},"authorAssociation":"CONTRIBUTOR","body":"> So I am not sure if it's a bug or a design choice for better performance or any other reason??\r\n\r\n@imusa007 I believe the reason was that we couldn't figure out the rules pandas uses to decide whether or not to return the index. If we can pin down exactly when to return the index versus not, we can/should match pandas behaviour.\r\n\r\nFYI: @mroeschke just in case you happen to know where to look in the pandas code base/documentation.","createdAt":"2024-02-12T18:18:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14977#issuecomment-1939290039","viewerDidAuthor":false},{"id":"IC_kwDOBWUGps5zmpVM","author":{"login":"mroeschke"},"authorAssociation":"CONTRIBUTOR","body":"Yeah unfortunately pandas doesn't have a clear rule for `groupby.apply` what type of index is returned when. Some factor that determine the resulting index is the use of `as_index` & whether the UDF returns scalars/same shape as input/mutates input.\r\n\r\nA user tried to bravely document the various scenarios but I am not sure how up to date this is: https://github.com/pandas-dev/pandas/issues/22545#issue-355718906","createdAt":"2024-02-12T20:21:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/rapidsai/cudf/issues/14977#issuecomment-1939510604","viewerDidAuthor":false}],"createdAt":"2024-02-06T19:51:54Z","id":"I_kwDOBWUGps5-dGYL","labels":[{"id":"MDU6TGFiZWw1OTk2MjY1NTk=","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":14977,"projectCards":[],"projectItems":[],"reactionGroups":[],"state":"OPEN","title":"[BUG] Output of ``GroupBy.apply`` is missing the grouping index","updatedAt":"2024-02-12T20:21:41Z","url":"https://github.com/rapidsai/cudf/issues/14977"}
